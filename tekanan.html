<!DOCTYPE html>

<html lang="id">

<head>

  <meta charset="UTF-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>perumdatirtaweningwilayah6.com</title>
  <meta name="description" content="Pantau logger tekanan air wilayah 6 dalam tampilan kartu dan grafik.">
  <meta property="og:title" content="Logger Tekanan • PDAM Wilayah 6" />
  <meta property="og:description" content="Monitoring tekanan air dan lokasi sensor secara real-time." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://perumdatirtaweningwilayah6.com/tekanan.html" />
  <meta property="og:image" content="https://perumdatirtawening.co.id/asset/image/logo-horizon-kecils.gif" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:image" content="https://perumdatirtawening.co.id/asset/image/logo-horizon-kecils.gif" />



  <!-- Bootstrap (samain versi dengan index) -->

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">



  <!-- FontAwesome -->

  <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>



  <!-- AOS Animation -->

  <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">



  <!-- Chart.js -->

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>



  <!-- Leaflet -->

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>



  <style>

    :root{

      --bg-card: rgba(16, 40, 78, 0.85);

      --glass: rgba(11, 31, 59, 0.7);

      --accent: #4db8ff;

    }

    /* Base */

    body{

      color:#fff;

      font-family:'Segoe UI', sans-serif;

      min-height:100vh;

      overflow-x:hidden;

      position:relative;

    }



    /* Background Video */

    #bg-video{

      position:fixed;

      right:0; bottom:0;

      min-width:100%; min-height:100%;

      object-fit:cover;

      z-index:-1;

      filter:brightness(40%) blur(1px);

    }
    @media (max-width:576px){ #bg-video{ display:none; } body{ background:#0b1f3b linear-gradient(180deg,#0b1f3b,#0a1c35); } }

    .overlay{

      position:fixed; inset:0;

      background:rgba(11,31,59,0.5);

      z-index:0;

    }



    /* Navbar (match index) */

    .navbar{

      background:var(--glass);

      box-shadow:0 2px 10px rgba(0,0,0,0.4);

      backdrop-filter:blur(8px);

      z-index:1;

    }

    .navbar-brand{

      display:flex; align-items:center; gap:10px;

      font-weight:bold; color:var(--accent) !important;

    }

    .nav-link{

      color:#d7e9ff !important;

    }

    .nav-link:hover{

      color:var(--accent) !important;

    }



    /* Cards (match index) */

    .card{

      background-color:var(--bg-card);

      border:none; border-radius:15px;

      padding:20px; color:#fff;

      box-shadow:0 0 10px rgba(0,0,0,0.3);

      transition:transform .3s ease, box-shadow .3s ease;

      z-index:1;

    }

    .card:hover{

      transform:translateY(-6px);

      box-shadow:0 0 20px var(--accent);

    }

    .section-title{

      color:var(--accent); font-weight:700;

    }



    /* Pressure numbers */

    .pressure-box{ font-size:2rem; font-weight:800; letter-spacing:.5px; }

    .low{ color:#ff6b6b !important; }

    .normal{ color:var(--accent) !important; }

    .high{ color:#51cf66 !important; }

    .alert-low{ color:#ff8787; font-size:13px; }

    .alert-high{ color:#8ce99a; font-size:13px; }



    /* Leaflet map */

    #map{ height:350px; border-radius:12px; overflow:hidden; }

    .leaflet-container{ background:transparent; }



    /* Table */

    table th{

      background:linear-gradient(90deg, rgba(77,184,255,.25), rgba(77,184,255,.05));

      color:#eaf6ff; border:0 !important;

    }

    table td, table th{ border-color:rgba(255,255,255,0.08) !important; color:#f4f9ff; }



    /* Footer */

    footer{

      text-align:center; padding:15px 0; color:#aaa;

      font-size:.9rem; border-top:1px solid rgba(255,255,255,0.1);

      margin-top:40px; z-index:1; position:relative;

    }

  </style>

  <link rel="stylesheet" href="css/responsive.css" />
  
  
  </head>

<body>

  <!-- Background Video -->

  <video autoplay muted loop playsinline id="bg-video">

    <source src="footage.mp4" type="video/mp4">

    Browser kamu tidak mendukung video background.

  </video>

  <div class="overlay"></div>



  <!-- Navbar (konsisten dgn index) -->

  <nav class="navbar navbar-dark px-4">

    <a class="navbar-brand" href="index.html">

      <img src="https://perumdatirtawening.co.id/asset/image/logo-horizon-kecils.gif" height="45" alt="Logo">

    </a>

    <div class="d-flex gap-2">

      <a class="btn btn-sm btn-outline-info" href="index.html">Halaman Utama</a>

    </div>

  </nav>



  <div class="container py-5">

    <div class="text-center mb-5" data-aos="fade-down">

      <h2 class="fw-bold text-info">Logger Tekanan / Sensor</h2>

      <p class="text-light">Pantau tekanan air dan lokasi sensor secara real-time</p>

    </div>



    <div class="row g-4">

      <!-- Grafik -->

      <div class="col-lg-8" data-aos="fade-up" data-aos-delay="100">

        <div class="card p-3">

          <h5 class="section-title mb-3"><i class="fa-solid fa-chart-line me-2"></i>Grafik Tekanan Air (bar)</h5>

          <canvas id="pressureChart" height="110"></canvas>

        </div>

      </div>



      <!-- Tekanan Saat Ini -->

      <div class="col-lg-4" data-aos="fade-up" data-aos-delay="150">

        <div class="card p-3 text-center">

          <h6 class="text-light-50 mb-3"><i class="fa-solid fa-gauge-high me-2"></i>Tekanan Saat Ini</h6>

          <div class="row">

            <div class="col-4">

              <p class="mb-1">Sensor 1</p>

              <div id="pressure1" class="pressure-box">--</div>

              <div id="alert1" class="alert-low d-none">Tekanan Rendah!</div>

              <div id="alert1h" class="alert-high d-none">Tekanan Tinggi!</div>

            </div>

            <div class="col-4">

              <p class="mb-1">Sensor 2</p>

              <div id="pressure2" class="pressure-box">--</div>

              <div id="alert2" class="alert-low d-none">Tekanan Rendah!</div>

              <div id="alert2h" class="alert-high d-none">Tekanan Tinggi!</div>

            </div>

            <div class="col-4">

              <p class="mb-1">Sensor 3</p>

              <div id="pressure3" class="pressure-box">--</div>

              <div id="alert3" class="alert-low d-none">Tekanan Rendah!</div>

              <div id="alert3h" class="alert-high d-none">Tekanan Tinggi!</div>

            </div>

          </div>

          <small id="lastUpdate" class="text-muted"></small>

        </div>

      </div>

    </div>



    <!-- Peta Sensor -->

    <div class="card p-3 mt-4" data-aos="fade-up" data-aos-delay="200">

      <h5 class="section-title mb-3"><i class="fa-solid fa-map-location-dot me-2"></i>Lokasi Sensor Tekanan</h5>

      <div id="map"></div>

    </div>



    <!-- Tabel Riwayat -->

    <div class="card p-3 mt-4" data-aos="fade-up" data-aos-delay="250">

      <h5 class="section-title mb-3"><i class="fa-solid fa-clock-rotate-left me-2"></i>Riwayat Pembacaan Tekanan</h5>

      <div class="table-responsive">

        <table class="table table-bordered text-center align-middle mb-0" id="dataTable">

          <thead>

            <tr>

              <th>Waktu</th>

              <th>Sensor 1 (bar)</th>

              <th>Sensor 2 (bar)</th>

              <th>Sensor 3 (bar)</th>

            </tr>

          </thead>

          <tbody></tbody>

        </table>

      </div>

    </div>

  </div>



  <!-- Footer (konsisten) -->

  <footer>© 2025 PDAM Wilayah6 . All rights reserved.</footer>



  <!-- JS -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>

  <script>

    AOS.init({ duration:800, once:true });

  </script>



  <!-- Audio Alert -->

  <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>



  <!-- App Script -->

  <script>

    // ====== Konfigurasi Data & API ======

    const CHANNEL_ID = 3102639;

    const API_URL = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=10`;

    const ALERT_URL = "https://script.google.com/macros/s/AKfycbz12345abcd/exec"; // ganti dgn URL GAS kamu



    // Lokasi Sensor (bisa tambah sesuai kebutuhan)

    const SENSOR_LOC = {

      sensor1: { name: "Reservoir Utama", lat: -6.908797487519382, lng: 107.59149047726712 },
 
      // sensor2: { name: "Zona Timur", lat: -6.92184, lng: 107.6344 },

      // sensor3: { name: "Zona Barat", lat: -6.9052, lng: 107.6014 }

    };



    // ====== Inisialisasi Peta (tema gelap) ======

    const map = L.map("map").setView([-6.914744, 107.60981], 13);

    L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {

      attribution: "&copy; OpenStreetMap &copy; CARTO"

    }).addTo(map);



    let markers = {};

    Object.keys(SENSOR_LOC).forEach(key => {

      const s = SENSOR_LOC[key];

      markers[key] = L.circleMarker([s.lat, s.lng], {

        color: "#4db8ff",

        radius: 10,

        fillOpacity: 0.7

      }).bindPopup(`<b>${s.name}</b><br>Menunggu data...`).addTo(map);

    });



    // ====== Chart.js (warna aksen konsisten) ======

    let chart;

    function renderChart(labels, p1, p2, p3){

      const ctx = document.getElementById("pressureChart");

      if(chart) chart.destroy();

      chart = new Chart(ctx, {

        type: "line",

        data: {

          labels,

          datasets: [

            { label:"Sensor 1", data:p1, borderColor:"#4db8ff", backgroundColor:"rgba(77,184,255,0.2)", fill:true, tension:.35 },

            { label:"Sensor 2", data:p2, borderColor:"#51cf66", backgroundColor:"rgba(81,207,102,0.15)", fill:true, tension:.35 },

            { label:"Sensor 3", data:p3, borderColor:"#ff8787", backgroundColor:"rgba(255,135,135,0.15)", fill:true, tension:.35 },

          ].filter(ds => ds.data.some(v => v>0))

        },

        options:{

          plugins:{ legend:{ position:"bottom", labels:{ color:"#eaf6ff" } } },

          scales:{

            x:{ ticks:{ color:"#d7e9ff" }, grid:{ color:"rgba(255,255,255,.08)" } },

            y:{ beginAtZero:true, ticks:{ color:"#d7e9ff" }, grid:{ color:"rgba(255,255,255,.08)" } }

          }

        }

      });

    }



    // ====== Alert Helpers ======

    let isBeeping = false;

    function playBeep(){

      if(!isBeeping){

        document.getElementById("alarmSound").play().catch(()=>{});

        isBeeping = true;

        setTimeout(()=>isBeeping=false,3000);

      }

    }

    function stopBeep(){

      const beep = document.getElementById("alarmSound");

      beep.pause(); beep.currentTime = 0; isBeeping = false;

    }



    function setMarkerStatus(key, v){

      let color = "#4db8ff";

      if (v < 0.3) color = "#ff6b6b";

      else if (v > 0.7) color = "#51cf66";

      markers[key].setStyle({ color });

      markers[key].bindPopup(`<b>${SENSOR_LOC[key].name}</b><br>Tekanan: ${v.toFixed(2)} bar`);

    }



    function updateSensor(id, alertLowId, alertHighId, value, key){

      const el = document.getElementById(id);

      const low = document.getElementById(alertLowId);

      const high = document.getElementById(alertHighId);

      const v = parseFloat(value || 0);



      el.textContent = isFinite(v) ? v.toFixed(2) : "--";

      el.className = "pressure-box";

      low.classList.add("d-none");

      high.classList.add("d-none");



      if (v < 0.3){

        el.classList.add("low");   low.classList.remove("d-none");

        playBeep();

      } else if (v > 0.7){

        el.classList.add("high");  high.classList.remove("d-none");

        stopBeep();

      } else {

        el.classList.add("normal");

        stopBeep();

      }

      if (SENSOR_LOC[key]) setMarkerStatus(key, v);

    }



    // ====== Load Data ======

    async function loadPressure(){

      try{

        // Cache-busting and disable caching to keep it fresh
        const url = API_URL + (API_URL.includes('?') ? '&' : '?') + 'ts=' + Date.now();
        const res = await fetch(url, { cache: 'no-store' });

        const data = await res.json();

        const feeds = data.feeds || [];



        const labels = feeds.map(f => new Date(f.created_at).toLocaleTimeString("id-ID"));

        const p1 = feeds.map(f => parseFloat(f.field1 || 0));

        const p2 = feeds.map(f => parseFloat(f.field2 || 0));

        const p3 = feeds.map(f => parseFloat(f.field3 || 0));

        const last = feeds[feeds.length - 1];



        if(last){

          updateSensor("pressure1","alert1","alert1h", last.field1, "sensor1");

          updateSensor("pressure2","alert2","alert2h", last.field2, "sensor2");

          updateSensor("pressure3","alert3","alert3h", last.field3, "sensor3");

          document.getElementById("lastUpdate").textContent =

            "Update: " + new Date(last.created_at).toLocaleString("id-ID");

        }



        // Table

        const tbody = document.querySelector("#dataTable tbody");

        tbody.innerHTML = feeds.slice().reverse().map(f => `

          <tr>

            <td>${new Date(f.created_at).toLocaleString("id-ID")}</td>

            <td>${Number.parseFloat(f.field1||0).toFixed(2)}</td>

            <td>${Number.parseFloat(f.field2||0).toFixed(2)}</td>

            <td>${Number.parseFloat(f.field3||0).toFixed(2)}</td>

          </tr>

        `).join("");



        // Chart

        renderChart(labels, p1, p2, p3);



      }catch(err){

        console.error("Gagal ambil data:", err);

      }

    }



    // Kirim notifikasi (contoh: Telegram/GAS)

    async function sendTelegram(key, value){

      const s = SENSOR_LOC[key];

      if(!s) return;

      const mapLink = `https://www.google.com/maps?q=${s.lat},${s.lng}`;

      try{

        await fetch(`${ALERT_URL}?sensor=${encodeURIComponent(s.name)}&tekanan=${value}&lokasi=${encodeURIComponent(mapLink)}`);

      }catch(e){}

    }



    // Trigger kirim alert saat low

    // (Opsional: panggil sendTelegram di dalam updateSensor saat low)



    loadPressure();

    setInterval(loadPressure, 15000);

  </script>

  

  <!-- Mobile Bottom Nav (visible only on small screens) -->
  <nav class="mobile-nav d-sm-none">
    <a href="index.html" aria-label="Home"><i class="fas fa-house"></i></a>
    <a href="peta.html" aria-label="Peta"><i class="fas fa-map"></i></a>
    <a href="Layanan.html" aria-label="Pengaduan"><i class="fas fa-bullhorn"></i></a>
    <a href="tekanan.html" class="active" aria-label="Logger"><i class="fas fa-gauge-high"></i></a>
  </nav>

</body>

</html>

