<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teknisi - Selesaikan Pekerjaan</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet"/>
  <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --brand:#4db8ff; --ink:#cfeaff; --panel: rgba(16, 40, 78, 0.85); --panel-soft: rgba(16, 40, 78, 0.65); }
    body { background:#0b1f3b; color:#fff; font-family:'Segoe UI',sans-serif; }
    .navbar { background: rgba(11,31,59,.7); box-shadow: 0 2px 10px rgba(0,0,0,.4); backdrop-filter: blur(8px); }
    .navbar-brand { color: var(--brand) !important; font-weight: 700; }
    .card { background: var(--panel); border: none; border-radius: 16px; color: #fff; }
    .card-header { background: var(--panel-soft); color: var(--ink); border-bottom: 1px solid rgba(255,255,255,.08); }
    .form-control, .form-select { background: rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.15); }
    .form-control::placeholder { color:#cfeaff; opacity:.6; }
    .btn-brand { background: var(--brand); color:#07263f; border:none; }
    a { color: var(--ink); }
    footer { text-align:center; color:#aaa; font-size:.9rem; padding:16px 0; border-top:1px solid rgba(255,255,255,.1); margin-top:24px; }
    #map-tek { height: 340px; border-radius: 12px; }
    .thumb { max-width: 100%; border-radius: 10px; border: 1px solid rgba(255,255,255,.2); }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark px-3">
  <a class="navbar-brand" href="index.html">
      <img src="https://perumdatirtawening.co.id/asset/image/logo-horizon-kecils.gif" height="42" class="me-2" alt="Logo"/>
      Modul Teknisi
    </a>
    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-sm btn-outline-info" href="admin-daftar-aduan.html">Daftar Aduan</a>
      <a class="btn btn-sm btn-outline-light" href="admin-login.html">Login Admin</a>
    </div>
  </nav>

  <div class="container py-4">
    <div class="text-center mb-3" data-aos="fade-down">
      <h3 class="fw-bold text-info"><i class="fas fa-screwdriver-wrench me-2"></i>Selesaikan Pekerjaan</h3>
      <p class="text-secondary">Isi form berikut untuk menandai tiket <em>Selesai</em>, unggah dokumentasi, dan set lokasi penyelesaian.</p>
    </div>

    <div class="row g-3">
      <div class="col-lg-7" data-aos="fade-up">
        <div class="card p-3 mb-3">
          <div class="card-header">Detail Pekerjaan</div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nomor Tiket</label>
                <input id="tiket" class="form-control" placeholder="TKT-xxxxxx">
              </div>
              <div class="col-md-6">
                <label class="form-label">Tanggal & Waktu Selesai</label>
                <input id="waktu" class="form-control" disabled>
              </div>
              <div class="col-md-6">
                <label class="form-label">Nama Teknisi</label>
                <input id="teknisi" class="form-control" placeholder="Nama teknisi">
              </div>
              <div class="col-md-6">
                <label class="form-label">Tim / Rayon</label>
                <input id="tim" class="form-control" placeholder="Nama tim/rayon">
              </div>
              <div class="col-12">
                <label class="form-label">Catatan Pekerjaan</label>
                <textarea id="catatan" rows="3" class="form-control" placeholder="Ringkas tindakan & hasil pemeriksaan"></textarea>
              </div>
              <div class="col-12">
                <label class="form-label">Dokumentasi Hasil (foto)</label>
                <input id="foto" type="file" accept="image/*" capture="environment" class="form-control">
                <small class="text-secondary">Bisa ambil langsung dari kamera.</small>
                <div class="mt-2" id="previewBox"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex gap-2">
          <button id="btnKirim" class="btn btn-brand" type="button">
            <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
            <span class="btn-text">Tandai Selesai</span>
          </button>
          <button id="btnReset" class="btn btn-outline-light" type="button">Reset</button>
        </div>
        <div class="mt-3" id="alertBox"></div>
      </div>

      <div class="col-lg-5" data-aos="fade-up" data-aos-delay="50">
        <div class="card p-3">
          <div class="card-header">Lokasi Penyelesaian</div>
          <div class="card-body">
            <div id="map-tek"></div>
            <div class="row g-2 mt-2">
              <div class="col-6"><input id="lat" class="form-control" placeholder="Latitude"></div>
              <div class="col-6"><input id="lng" class="form-control" placeholder="Longitude"></div>
            </div>
            <div class="mt-3 d-flex flex-wrap gap-2">
              <button class="btn btn-primary" id="btnSetLoc" type="button"><i class="fas fa-location-crosshairs me-2"></i>Set dari Input</button>
              <button class="btn btn-success" id="btnGeo" type="button"><i class="fas fa-location-arrow me-2"></i>Pakai Lokasi Saya</button>
              <button class="btn btn-outline-light" id="btnClear" type="button"><i class="fas fa-undo me-2"></i>Reset</button>
            </div>
            <small class="text-secondary d-block mt-2">Klik peta untuk isi koordinat otomatis.</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>© 2025 PDAM Tirtawening — Modul Teknisi</footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
  <script>AOS.init({duration:800, once:true});</script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ====== KONFIG ENDPOINT ======
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyfSbzjl6j6Ctd3YkOFnjtEId5Ouhc-Wfm6J2zDudogCAVyLQZjZgthBzw42S-bjxWNBw/exec";
const TEKNISI_ENDPOINT = GAS_URL; // WAJIB: aktifkan kirim ke DataTeknisi

    // ====== Helper UI ======
    const alertBox = document.getElementById('alertBox');
    function alertMsg(type, html) { alertBox.innerHTML = '<div class="alert alert-'+type+'">'+html+'</div>'; }
    const btnKirim = document.getElementById('btnKirim');
    const btnSpin  = btnKirim.querySelector('.spinner-border');
    const btnText  = btnKirim.querySelector('.btn-text');
    function setLoading(b) { btnKirim.disabled=b; btnSpin.classList.toggle('d-none', !b); btnText.textContent = b?'Mengirim...':'Tandai Selesai'; }

    // ====== Waktu selesai ======
    const waktu = document.getElementById('waktu');
    function setWaktuNow(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); waktu.value = d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+' '+pad(d.getHours())+':'+pad(d.getMinutes())+' WIB'; }
    setWaktuNow();

    // ====== Preview foto ======
    const foto = document.getElementById('foto');
    const previewBox = document.getElementById('previewBox');
    foto.addEventListener('change', ()=>{
      previewBox.innerHTML=''; const f=foto.files[0]; if(!f) return;
      const img=document.createElement('img'); img.className='thumb mt-2'; img.alt='Preview dokumentasi';
      const r=new FileReader(); r.onload=()=>img.src=r.result; r.readAsDataURL(f); previewBox.appendChild(img);
    });

    // ====== Leaflet Map ======
    let map=null, marker=null;
    const elLat=document.getElementById('lat'), elLng=document.getElementById('lng');
    if (typeof L!=='undefined') {
      map=L.map('map-tek',{zoomControl:true, preferCanvas:true}).setView([-6.9147,107.6098],12);
      const providers=[{u:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',o:{maxZoom:19}},{u:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',o:{maxZoom:20}}];
      let tl=L.tileLayer(providers[0].u,providers[0].o).addTo(map);
      tl.on('tileerror',()=>{ map.removeLayer(tl); tl=L.tileLayer(providers[1].u,providers[1].o).addTo(map); });
      function setPoint(lat,lng,zoom=true){ const pos=[lat,lng]; elLat.value=Number(lat).toFixed(6); elLng.value=Number(lng).toFixed(6); if(!marker) marker=L.marker(pos).addTo(map); else marker.setLatLng(pos); if(zoom) map.setView(pos, Math.max(map.getZoom(),16)); }
      map.on('click', e=>setPoint(e.latlng.lat,e.latlng.lng,false));
      document.getElementById('btnSetLoc').addEventListener('click',()=>{ const la=parseFloat(elLat.value), lo=parseFloat(elLng.value); if(!Number.isFinite(la)||!Number.isFinite(lo)) return alert('Isi latitude/longitude valid.'); setPoint(la,lo,true); });
      document.getElementById('btnClear').addEventListener('click',()=>{ elLat.value=''; elLng.value=''; if(marker){map.removeLayer(marker); marker=null;} map.setView([-6.9147,107.6098],12); });
      document.getElementById('btnGeo').addEventListener('click',()=>{ if(!navigator.geolocation) return alert('Geolocation tidak didukung.'); navigator.geolocation.getCurrentPosition(p=>setPoint(p.coords.latitude,p.coords.longitude,true), e=>{console.error(e); alert('Gagal ambil lokasi.');},{enableHighAccuracy:true,timeout:8000,maximumAge:0}); });
    }

    // ====== Utils ======
    function toDataURL(file){ return new Promise((res,rej)=>{ if(!file) return res(''); const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
    function resetForm(){ ['tiket','teknisi','tim','catatan'].forEach(id=>document.getElementById(id).value=''); foto.value=''; previewBox.innerHTML=''; if (elLat) elLat.value=''; if (elLng) elLng.value=''; if(marker&&map){map.removeLayer(marker); marker=null;} if(map) map.setView([-6.9147,107.6098],12); setWaktuNow(); }

    // ====== Submit ======
    async function submitTeknisi(){
      const tiket=document.getElementById('tiket').value.trim();
      const teknisi=document.getElementById('teknisi').value.trim();
      const tim=document.getElementById('tim').value.trim();
      const catatan=document.getElementById('catatan').value.trim();
      const la=elLat.value.trim(), lo=elLng.value.trim();
      const lokasi=(la&&lo)?(la+','+lo):'';
      if(!tiket){ alertMsg('warning','Nomor tiket wajib diisi.'); return; }

      setLoading(true); alertMsg('info','Mengirim...');
      try{
        // 1) wajib: update status selesai (triger notif)
        const respUpd = await fetch(GAS_URL+'?mode=update&tiket='+encodeURIComponent(tiket)+'&status='+encodeURIComponent('Selesai'));
        const jUpd = await respUpd.json();
        if (jUpd.status!=='success'){ setLoading(false); return alertMsg('danger','Gagal update status tiket.'); }

        // 2) opsional: kirim detail teknisi jika endpoint ada
        if (TEKNISI_ENDPOINT){
          const dokumentasi = await toDataURL(document.getElementById('foto').files[0]);
          const payload = new URLSearchParams({ mode:'teknisi_selesai', tiket, teknisi, tim, catatan, lokasi, waktu:waktu.value, dokumentasi });
          await fetch(TEKNISI_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: payload.toString() });
        }

        alertMsg('success','Tiket <strong>'+tiket+'</strong> ditandai <strong>Selesai</strong>. Data teknisi tersimpan.');
        resetForm();
        setTimeout(()=> alertBox.innerHTML='', 4000);
      }catch(err){
        console.error(err);
        alertMsg('danger','Gagal mengirim. Cek koneksi & endpoint.');
      }finally{
        setLoading(false);
      }
    }

    document.getElementById('btnKirim').addEventListener('click', submitTeknisi);
    document.getElementById('btnReset').addEventListener('click', resetForm);

    // Prefill tiket dari query
    const tk = new URLSearchParams(location.search).get('tiket');
    if (tk) document.getElementById('tiket').value = tk;
  });
  </script>
</body>
</html>
