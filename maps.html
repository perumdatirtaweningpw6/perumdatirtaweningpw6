<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peta Pelanggan PDAM</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html,body{height:100%;margin:0;font-family:"Poppins",sans-serif;transition:background 0.3s ease;}
  body.light{background:#eef2f7;color:#111;}
  body.dark{background:#0b1f3b;color:#fff;}
  #map{height:100%;width:100%;}

  /* switch kiri */
  .switch-container{position:absolute;top:80px;left:10px;z-index:1000;display:flex;flex-direction:column;gap:6px;
    background:rgba(255,255,255,0.9);border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.3);padding:6px;}
  body.dark .switch-container{background:rgba(0,0,0,0.7);}
  .switch-btn{background:transparent;border:none;font-size:1rem;cursor:pointer;border-radius:8px;padding:4px 8px;color:#222;}
  .switch-btn.active{background:#007bff;color:#fff;}
  body.dark .switch-btn{color:#fff;}

  /* Popup card */
  .popup-card{width:320px;background:#fff;border-radius:12px;overflow:hidden;
    box-shadow:0 4px 10px rgba(0,0,0,0.3);color:#000;font-size:0.85rem;}
  body.dark .popup-card{background:#10233f;color:#f2f2f2;}
  .popup-header{padding:10px 12px 4px;border-bottom:1px solid #ddd;}
  .popup-header h3{margin:0;font-size:1.05rem;font-weight:600;}
  .popup-header small{color:#777;}
  .menuju-lokasi{display:inline-block;font-size:0.75rem;background:#c5f6c5;color:#2e7d32;border-radius:20px;
    padding:3px 10px;margin-top:4px;text-decoration:none;}
  .popup-body{padding:10px 12px;}
  .popup-status{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
  .status-label{padding:2px 8px;border-radius:10px;font-size:0.75rem;color:#fff;}
  .sudah{background:#00f43d;}
  .tunggakan{background:#d93025;}
  .popup-tab{display:flex;border-bottom:1px solid #ccc;font-size:0.8rem;margin-bottom:6px;}
  .popup-tab div{flex:1;text-align:center;padding:6px 0;cursor:pointer;}
  .popup-tab div.active{color:#4caf50;font-weight:600;border-bottom:2px solid #4caf50;}
  .popup-section{display:none;}
  .popup-section.active{display:block;}
  .popup-section table{width:100%;border-collapse:collapse;font-size:0.8rem;}
  .popup-section td{padding:4px 6px;vertical-align:top;}
  .popup-section td:first-child{color:#4caf50;font-weight:500;width:40%;}
  @media(max-width:600px){.popup-card{width:90vw;}}

  /* search kanan atas */
  .search-box {
    position: absolute;
    top: 15px;
    right: 15px;
    z-index: 9999;
    background: rgba(255,255,255,0.95);
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .search-box input {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 5px 8px;
    width: 180px;
  }
  .search-box button {
    background: #007bff;
    border: none;
    color: #fff;
    border-radius: 4px;
    padding: 6px 10px;
    cursor: pointer;
  }
  .search-box button:hover {
    background: #0056b3;
  }
</style>
</head>
<body class="light">

<!-- üîç Search pelanggan -->
<div class="search-box">
  <input type="text" id="searchNama" placeholder="Cari nama pelanggan..." />
  <button id="btnCari">Cari</button>
</div>

<div id="map"></div>

<div class="switch-container">
  <div class="switch-item"><input type="radio" name="mapmode" id="lightBtn" checked></div>
  <div class="switch-item"><input type="radio" name="mapmode" id="darkBtn"></div>
  <div class="switch-item"><input type="radio" name="mapmode" id="satBtn"></div>
</div>

<script>
  // üî¢ Format angka ke Rupiah
function formatRupiah(angka) {
  if (!angka || isNaN(angka)) return "Rp 0";
  return "Rp " + Number(angka).toLocaleString("id-ID");
}
const scriptURL="https://script.google.com/macros/s/AKfycbz3X15bIek1QQ2HaOfNTH55wFyZD0HLTebtYSeKtnbda2VLqTy32-uhY_R2O3X9ZmQ7RQ/exec";
const map=L.map('map').setView([-6.9457,107.6093],13);
const baseLayers={
  light:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
  dark:L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'),
  sat:L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
};
baseLayers.light.addTo(map);

let pelangganLayer;
const markers = []; // üü¢ array global untuk semua marker pelanggan

async function loadData(){
  const res=await fetch(scriptURL);
  const data=await res.json();
  if(pelangganLayer) map.removeLayer(pelangganLayer);

  pelangganLayer=L.geoJSON(data,{
    pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:7,fillColor:"#4db8ff",color:"#fff",weight:1,fillOpacity:0.9}),
    onEachFeature:(f,layer)=>{
      const p=f.properties;
      const statusClass=(p["Status Planggan"]||"").toLowerCase().includes("nunggak")?"tunggakan":"sudah";
      

      const popupHTML=`
        <div class="popup-card">
          <div class="popup-header">
            <h3>${p.Nama||"Pelanggan"} <small>${p.ID||""}</small></h3>
            <a class="menuju-lokasi" target="_blank" href="https://www.google.com/maps?q=${p.Latitude},${p.Longtitude}">üìç Menuju Lokasi</a>
          </div>
          <div class="popup-body">
            <div class="popup-status">
              <div>Pemakaian: <b>${formatMeterKubik(p.Pemakaian)}</b></div>
              <div class="status-label ${statusClass}">${p["Status Planggan"]||"Belum Terbayar"}</div>
              
            </div>
            <div class="popup-tab">
              <div class="tab-btn active" data-tab="detail">Pelanggan</div>
              <div class="tab-btn" data-tab="tagihan">Tagihan</div>
              <div class="tab-btn" data-tab="foto">Foto</div>
            </div>
            <div class="popup-section active" id="detail">
              <table>
                <tr><td>Alamat</td><td>${p.Alamat||"-"}</td></tr>
                <tr><td>Kelurahan</td><td>${p.Kelurahan||"-"}</td></tr>
                <tr><td>Kecamatan</td><td>${p.Kecamatan||"-"}</td></tr>
              </table>
            </div>
            <div class="popup-section" id="tagihan">
              <table>
                <tr><td>Tagihan</td><td>${formatRupiah(p.Tagihan)}</td></tr>
                <tr><td>Status</td><td>${p.StatusBilling||"-"}</td></tr>
                <tr><td>Tunggakan</td><td>${formatRupiah(p.Tunggakan)}</td></tr>
                <tr><td>Keterangan Cater</td><td>${p.Ketcatat||"-"}</td></tr>

              </table>
            </div>
            <div class="popup-section" id="foto">
              ${p["Foto Rumah"]?`<img src="${p["Foto Rumah"]}" style="width:100%;border-radius:8px;">`:"<p>Tidak ada foto.</p>"}
            </div>
          </div>
        </div>`;
      layer.bindPopup(popupHTML);

      // üü¢ simpan nama ke marker
      if (p.Nama) {
        layer.nama = p.Nama.toLowerCase();
        markers.push(layer);
      }

      // aktifkan tab popup
      layer.on("popupopen",()=>{
        const popup=layer.getPopup().getElement();
        const tabs=popup.querySelectorAll(".tab-btn");
        const sections=popup.querySelectorAll(".popup-section");
        tabs.forEach(btn=>{
          btn.addEventListener("click",()=>{
            tabs.forEach(b=>b.classList.remove("active"));
            btn.classList.add("active");
            sections.forEach(s=>s.classList.remove("active"));
            popup.querySelector(`#${btn.dataset.tab}`).classList.add("active");
          });
        });
      });
    }
  }).addTo(map);
  map.fitBounds(pelangganLayer.getBounds());
// üî¢ Format angka ke satuan m¬≥ (meter kubik)
function formatMeterKubik(angka) {
  if (!angka || isNaN(angka)) return "0 m¬≥";
  return Number(angka).toLocaleString("id-ID") + " m¬≥";
}
}
loadData();

// üü¢ SEARCH NAMA PELANGGAN
function cariNama() {
  const input = document.getElementById("searchNama").value.toLowerCase();
  if (!input) return;
  const found = markers.find(m => m.nama && m.nama.includes(input));
  if (found) {
    map.flyTo(found.getLatLng(), 17, { duration: 1.2 });
    found.openPopup();
  } else {
    alert("Nama pelanggan tidak ditemukan!");
  }
}
document.getElementById("btnCari").addEventListener("click", cariNama);
document.getElementById("searchNama").addEventListener("keypress", e => {
  if (e.key === "Enter") cariNama();
});

// switch layer
const lightBtn=document.getElementById('lightBtn');
const darkBtn=document.getElementById('darkBtn');
const satBtn=document.getElementById('satBtn');
const allBtns=[lightBtn,darkBtn,satBtn];
function setBase(mode,btn){
  for(let key in baseLayers){if(map.hasLayer(baseLayers[key])) map.removeLayer(baseLayers[key]);}
  if(mode==="light"){baseLayers.light.addTo(map);document.body.className="light";}
  else if(mode==="dark"){baseLayers.dark.addTo(map);document.body.className="dark";}
  else{baseLayers.sat.addTo(map);document.body.className="light";}
}
lightBtn.onclick=()=>setBase("light",lightBtn);
darkBtn.onclick=()=>setBase("dark",darkBtn);
satBtn.onclick=()=>setBase("sat",satBtn);
</script>
</body>
</html>
