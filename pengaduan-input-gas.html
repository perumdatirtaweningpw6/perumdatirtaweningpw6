

<!DOCTYPE html>

<html lang="id">

<head>

  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>perumdatirtaweningwilayah6.com</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>

  <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>

    :root { --brand:#4db8ff; --ink:#cfeaff; --panel: rgba(16, 40, 78, 0.85); --panel-soft: rgba(16, 40, 78, 0.65); }

    body { color: #fff; font-family: 'Segoe UI', sans-serif; min-height: 100vh; overflow-x: hidden; position: relative; }

    #bg-video { position: fixed; right: 0; bottom: 0; min-width: 100%; min-height: 100%; object-fit: cover; z-index: -1; filter: brightness(40%) blur(1px); }

    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(11, 31, 59, 0.5); z-index: 0; }

    .navbar { background: rgba(11, 31, 59, 0.7); box-shadow: 0 2px 10px rgba(0,0,0,0.4); backdrop-filter: blur(8px); z-index: 1; }

    .navbar-brand { display: flex; align-items: center; gap: 10px; font-weight: bold; color: var(--brand) !important; }

    .card { background-color: var(--panel); border: none; border-radius: 16px; color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.3); }

    .card-header { background: var(--panel-soft); border-bottom: 1px solid rgba(255,255,255,0.08); color: var(--ink); }

    .form-control, .form-select { background: rgba(255,255,255,0.08); color: #fff; border: 1px solid rgba(255,255,255,0.12); }

    .form-control::placeholder { color: #cfeaff; opacity: .6; }

    .btn-brand { background: var(--brand); color: #07263f; border: none; }

    footer { text-align: center; padding: 20px 0; color: #aaa; font-size: 0.9rem; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 30px; z-index: 1; position: relative; }

    #map { width: 100%; height: 340px; border-radius: 12px; }

    /* Image preview */
    .thumb { max-width: 220px; width: 100%; height: auto; border-radius: 10px; border: 1px solid rgba(255,255,255,.2); display:block; }
    @media (max-width: 576px){ .thumb{ max-width: 140px; } }

    /* Map toggle & modal (mobile: prefer modal fullscreen) */
    #btnToggleMap{ display:none; }
    #btnOpenMapModal{ display:none; }
    #mapWrap{ display:block; }
    @media (max-width: 576px){
      #btnOpenMapModal{ display:inline-block; }
      #btnToggleMap{ display:none !important; }
      #mapWrap{ display:none !important; }
    }

  </style>

  <link rel="stylesheet" href="css/responsive.css" />
  
  
  </head>

<!-- Leaflet (pastikan tidak dobel di halaman) -->

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<body>

  <video autoplay muted loop playsinline id="bg-video">

    <source src="footage.mp4" type="video/mp4">

  </video>

  <div class="overlay"></div>



  <nav class="navbar navbar-dark px-4">

    <a class="navbar-brand" href="index.html">

      <img src="https://perumdatirtawening.co.id/asset/image/logo-horizon-kecils.gif" height="45" alt="Logo">

    </a>

    <div class="ms-auto d-flex gap-2">

      <a class="btn btn-sm btn-outline-info" href="index.html">Beranda</a>

    </div>

    

  </nav>



  <div class="container py-4">

    <div class="text-center mb-3" data-aos="fade-down">

      <h3 class="fw-bold text-info"><i class="fas fa-file-circle-plus me-2"></i>Input Pengaduan </h3>

      <p class="subtitle">Kirim Data Pengaduan Dengan Lengkap Dan Benar</p>

    </div>



    <div class="row g-3">

      <div class="col-lg-7 order-2 order-lg-1" data-aos="fade-up">

        <div class="card p-3">

          <div class="card-header">Data Aduan</div>

          <div class="card-body">

            <div class="row g-3">

              <div class="col-md-6">

                <label class="form-label">Nama Pelanggan</label>

                <input id="nama" class="form-control" placeholder="Nama">

              </div>

              <div class="col-md-6">

                <label class="form-label">Nomor Pelanggan</label>

                <input id="nopel" class="form-control" placeholder="No. Sambungan">

              </div>

              <div class="col-12">

                <label class="form-label">Alamat</label>

                <input id="alamat" class="form-control" placeholder="Alamat lengkap">

              </div>

              <div class="col-md-6">

                <label class="form-label">Kontak (HP)</label>

                <input id="kontak" class="form-control" placeholder="08xxx">

              </div>

              <div class="col-md-6">

                <label class="form-label">Jenis Keluhan</label>

                <select id="jenis" class="form-select">

                  <option value="Air Kecil">Air Kecil</option>

                  <option value="Air Mati">Air Mati</option>

                  <option value="Kebocoran">Kebocoran</option>

                  <option value="Meter Rusak">Meter Rusak</option>

                  <option value="Lainnya">Lainnya</option>

                </select>

              </div>

              <div class="col-12">

                <label class="form-label">Keterangan</label>

                <textarea id="keterangan" class="form-control" rows="4" placeholder="Jelaskan keluhan..."></textarea>

              </div>

              <div class="col-12">
                <label class="form-label mb-1">Foto (opsional)</label>
                <input id="fotoSebelum" type="file" accept="image/*" capture="environment" class="form-control">
                <small class="text-secondary">Ambil foto kondisi kerusakan.</small>
                <div class="mt-2" id="previewSebelum"></div>
              </div>
              <div class="col-12">
                <label class="form-label mb-1">Foto (opsional)</label>
                <input id="fotoSesudah" type="file" accept="image/*" capture="environment" class="form-control">
                <small class="text-secondary">Ambil foto kondisi kerusakan.</small>
                <div class="mt-2" id="previewSesudah"></div>
              </div>

            </div>

          </div>

        </div>



        <div class="mt-3 d-flex gap-2">

          <button class="btn btn-brand" id="btnKirim">Kirim </button>

          <a class="btn btn-outline-light" href="admin-login.html">Admin</a>

        </div>

        <div class="mt-3" id="alertBox"></div>

      </div>



      <div class="col-lg-5 order-1 order-lg-2" data-aos="fade-up" data-aos-delay="100">

        <!-- ====== Card Lokasi Aduan (ID unik) ====== -->

<div class="card p-3">

  <div class="card-header">Lokasi Aduan</div>

  <div class="card-body">

    <div class="d-flex gap-2 mb-2">
      <button id="btnToggleMap" class="btn btn-outline-info btn-sm" type="button">
        <i class="fas fa-map-location-dot me-2"></i>Tampilkan Peta
      </button>
      <button id="btnOpenMapModal" class="btn btn-info btn-sm d-sm-none" type="button">
        <i class="fas fa-location-dot me-2"></i>Pilih Lokasi (Fullscreen)
      </button>
    </div>
    <div id="mapWrap">
      <div id="map-aduan" style="height: 350px; border-radius: 10px;"></div>
    </div>



    <div class="row g-2 mt-2">

      <div class="col-6">

        <input id="lat-aduan" class="form-control" placeholder="Latitude">

      </div>

      <div class="col-6">

        <input id="lng-aduan" class="form-control" placeholder="Longitude">

      </div>

    </div>



    <div class="mt-3 d-flex flex-wrap gap-2">

      <button class="btn btn-primary" id="btn-set-aduan">

        <i class="fas fa-location-crosshairs me-2"></i>Set dari Input

      </button>

      <button class="btn btn-outline-light" id="btn-reset-aduan">

        <i class="fas fa-undo me-2"></i>Reset

      </button>

      <button class="btn btn-success" id="btn-geo-aduan">

        <i class="fas fa-location-arrow me-2"></i>Pakai Lokasi Saya

      </button>

    </div>



    <small class="text-secondary d-block mt-2">

      Klik peta untuk mengisi latitude/longitude otomatis. Atau gunakan tombol di atas.

    </small>

  </div>

</div>



      </div>

    </div>

  </div>



  <footer class="mt-4 text-center text-secondary">Â© 2025 PDAM Wilayah6 . All rights reserved.</footer>



  <!-- Map Picker Modal (fullscreen on small screens) -->
  <div class="modal fade modal-fullscreen-sm-down" id="mapModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background: rgba(16,40,78,.96); color:#e6f3ff;">
        <div class="modal-header border-0">
          <h5 class="modal-title"><i class="fas fa-location-dot me-2"></i>Pilih Lokasi</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body pt-0">
          <div id="map-aduan-modal" style="height: 70vh; border-radius: 12px;"></div>
          <div class="d-flex flex-wrap gap-2 mt-3">
            <button class="btn btn-success" id="btnGeoModal" type="button"><i class="fas fa-location-arrow me-2"></i>Pakai Lokasi Saya</button>
            <button class="btn btn-primary ms-auto" id="btnSaveModal" type="button"><i class="fas fa-check me-2"></i>Simpan Lokasi</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>

  <script>AOS.init({duration:800, once:true});</script>

  <script>

    // === SET YOUR APPS SCRIPT DEPLOYMENT URL HERE ===

    const GAS_URL = "https://script.google.com/macros/s/AKfycbwMLCYvMZIM9uMuZlzqsnhroINTh8gcLr9fQcbQLTTP4LcqzBSO50hFJCfAFncBNnW5Bw/exec"; // TODO: ganti dengan URL web app



    function alertMsg(type, msg){

      alertBox.innerHTML = '<div class="alert alert-'+type+'">'+msg+'</div>';

    }



    function toDataURL(file){

      return new Promise((resolve, reject)=>{

        if(!file) return resolve("");

        const reader = new FileReader();

        reader.onload = ()=> resolve(reader.result); // data:image/...;base64,XXXX

        reader.onerror = reject;

        reader.readAsDataURL(file);

      });

    }



    async function submitForm(){

      const nama = document.getElementById('nama').value.trim();

      const nopel = document.getElementById('nopel').value.trim();

      const alamat = document.getElementById('alamat').value.trim();

      const kontak = document.getElementById('kontak').value.trim();

      const jenis = document.getElementById('jenis').value;

      const keterangan = document.getElementById('keterangan').value.trim();

      const lat = document.getElementById('lat').value.trim();

      const lng = document.getElementById('lng').value.trim();

      const lokasi = (lat && lng) ? (lat+','+lng) : "";



      if(!nama || !alamat){

        alertMsg('warning','Nama dan alamat wajib diisi.');

        return;

      }



      const fotoFile = document.getElementById('foto').files[0];

      const dokumentasi = await toDataURL(fotoFile); // bisa "" kalau tidak ada



      const payload = new URLSearchParams({

        nama: nama,

        nopelanggan: nopel,

        alamat: alamat,

        kontak: kontak,

        jenis: jenis,

        keterangan: keterangan,

        lokasi: lokasi,

        dokumentasi: dokumentasi

      });



      try{

        alertMsg('info','Mengirim...');

        const resp = await fetch(GAS_URL, {

          method: 'POST',

          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },

          body: payload.toString()

        });

        const json = await resp.json();

        if(json.status === 'success'){

          alertMsg('success', 'Aduan terkirim! Tiket: <strong>'+json.ticket+'</strong>');

          setTimeout(()=> location.href = 'pengaduan-daftar-gas.html', 800);

        } else {

          alertMsg('danger', 'Gagal: '+(json.message||'Unknown error'));

        }

      } catch(err){

        console.error(err);

        alertMsg('danger','Error jaringan atau CORS. Pastikan URL Apps Script benar & di-deploy sebagai Web App (Anyone).');

      }

    }



    document.getElementById('btnKirim').addEventListener('click', submitForm);

  </script>

<!-- JANGAN duplikasi Leaflet. Cukup sekali di <head> atau di atas ini -->

<!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" /> -->

<!-- <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script> -->



<script>

document.addEventListener('DOMContentLoaded', () => {

  // === Apps Script URL ===

  const GAS_URL = "https://script.google.com/macros/s/AKfycbz5BaQOUHGv_B9wHAraZB3vtbxBwnKgATsXvfb0WpwQ9NYausrgsfusi4LHlvxLFzfs3Q/exec";



  // ====== MAP (lazy init + toggle) ======
  let map = null, marker = null;
  const elLat = document.getElementById('lat-aduan');
  const elLng = document.getElementById('lng-aduan');
  const mapWrap = document.getElementById('mapWrap');
  const btnToggleMap = document.getElementById('btnToggleMap');
  const isMobile = window.matchMedia('(max-width: 576px)').matches;

  function initMap(){
    if (map || typeof L==='undefined') return;
    map = L.map('map-aduan', { zoomControl: true, preferCanvas: true }).setView([-6.9147, 107.6098], 12);
    const providers=[
      {u:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',o:{maxZoom:19}},
      {u:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',o:{maxZoom:20}}
    ];
    let tl=L.tileLayer(providers[0].u,providers[0].o).addTo(map);
    tl.on('tileerror',()=>{ try{ map.removeLayer(tl); }catch(_){} tl=L.tileLayer(providers[1].u,providers[1].o).addTo(map); });
    map.on('click', (e) => setPoint(e.latlng.lat, e.latlng.lng, false));
    setTimeout(()=>{ try{ map.invalidateSize(); }catch(_){} }, 0);
  }

  function setPoint(lat, lng, zoomTo = true){
    const pos=[lat,lng];
    if (elLat) elLat.value = Number(lat).toFixed(6);
    if (elLng) elLng.value = Number(lng).toFixed(6);
    if (!map) return;
    if (!marker) marker = L.marker(pos).addTo(map); else marker.setLatLng(pos);
    if (zoomTo) map.setView(pos, Math.max(map.getZoom(), 16));
  }

  function showMap(){ if (mapWrap){ mapWrap.style.display='block'; } if(btnToggleMap){ btnToggleMap.innerHTML='<i class="fas fa-eye-slash me-2"></i>Sembunyikan Peta'; } if (!map) initMap(); else setTimeout(()=>{ try{ map.invalidateSize(); }catch(_){} },0); }
  function hideMap(){ if (mapWrap){ mapWrap.style.display='none'; } if(btnToggleMap){ btnToggleMap.innerHTML='<i class=\"fas fa-map-location-dot me-2\"></i>Tampilkan Peta'; } }

  if (btnToggleMap){ btnToggleMap.addEventListener('click', ()=>{ const hidden = mapWrap && getComputedStyle(mapWrap).display==='none'; if (hidden) showMap(); else hideMap(); }); }

  if (!isMobile && typeof L!=='undefined') { initMap(); }

  // tombol-tombol lokasi
  const btnSet = document.getElementById('btn-set-aduan');
  const btnReset = document.getElementById('btn-reset-aduan');
  const btnGeo = document.getElementById('btn-geo-aduan');

  if (btnSet) btnSet.addEventListener('click', () => {
    if (isMobile) showMap();
    if (!map) initMap();
    const lat = parseFloat(elLat.value);
    const lng = parseFloat(elLng.value);
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) return alert('Isi latitude & longitude valid.');
    setPoint(lat, lng, true);
  });

  if (btnReset) btnReset.addEventListener('click', () => {
    if (elLat) elLat.value = ''; if (elLng) elLng.value = '';
    if (marker && map) { map.removeLayer(marker); marker = null; }
    if (map) map.setView([-6.9147, 107.6098], 12);
  });

  if (btnGeo) btnGeo.addEventListener('click', () => {
    if (isMobile) showMap();
    if (!navigator.geolocation) return alert('Geolocation tidak didukung browser.');
    navigator.geolocation.getCurrentPosition(
      (pos) => { if (!map) initMap(); setPoint(pos.coords.latitude, pos.coords.longitude, true); },
      (err) => { console.error(err); alert('Gagal ambil lokasi. Aktifkan izin lokasi.'); },
      { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
    );
  });

  // ====== Map Modal (fullscreen on mobile) ======
  const mapModalEl = document.getElementById('mapModal');
  const btnOpenMapModal = document.getElementById('btnOpenMapModal');
  let modalMap = null, modalMarker = null;

  function initModalMap(){
    if (modalMap || typeof L==='undefined') return;
    modalMap = L.map('map-aduan-modal', { zoomControl:true, preferCanvas:true }).setView([-6.9147, 107.6098], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(modalMap);
    modalMap.on('click', (e)=> setPointModal(e.latlng.lat, e.latlng.lng, false));
  }
  function setPointModal(lat, lng, zoomTo=true){
    const pos=[lat,lng];
    if (!modalMap) return;
    if (!modalMarker) modalMarker = L.marker(pos).addTo(modalMap); else modalMarker.setLatLng(pos);
    if (zoomTo) modalMap.setView(pos, Math.max(modalMap.getZoom(),16));
  }
  function syncInputsFromModal(){
    if (!modalMarker) return;
    const pos = modalMarker.getLatLng();
    if (elLat) elLat.value = Number(pos.lat).toFixed(6);
    if (elLng) elLng.value = Number(pos.lng).toFixed(6);
  }
  if (btnOpenMapModal && mapModalEl){
    const bsModal = new bootstrap.Modal(mapModalEl);
    btnOpenMapModal.addEventListener('click', ()=>{ bsModal.show(); });
    mapModalEl.addEventListener('shown.bs.modal', ()=>{
      initModalMap();
      setTimeout(()=>{ try{ modalMap.invalidateSize(); }catch(_){} }, 0);
      const la=parseFloat(elLat?.value), lo=parseFloat(elLng?.value);
      if (Number.isFinite(la) && Number.isFinite(lo)) setPointModal(la,lo,true);
    });
    document.getElementById('btnGeoModal')?.addEventListener('click', ()=>{
      if (!navigator.geolocation) return alert('Geolocation tidak didukung browser.');
      navigator.geolocation.getCurrentPosition((pos)=>{
        initModalMap(); setPointModal(pos.coords.latitude, pos.coords.longitude, true);
      }, (err)=>{ console.error(err); alert('Gagal ambil lokasi. Aktifkan izin lokasi.'); }, {enableHighAccuracy:true, timeout:8000, maximumAge:0});
    });
    document.getElementById('btnSaveModal')?.addEventListener('click', ()=>{ syncInputsFromModal(); bsModal.hide(); });
  }



  // ====== Preview foto (sebelum & sesudah) ======
  const fotoSebelum = document.getElementById('fotoSebelum');
  const fotoSesudah = document.getElementById('fotoSesudah');
  const previewSebelum = document.getElementById('previewSebelum');
  const previewSesudah = document.getElementById('previewSesudah');

  function setupPreview(input, previewBox, alt){
    if (!input || !previewBox) return;
    input.addEventListener('change', ()=>{
      previewBox.innerHTML=''; const f=input.files[0]; if(!f) return;
      const img=document.createElement('img'); img.className='thumb mt-2'; img.alt=alt;
      const r=new FileReader(); r.onload=()=>img.src=r.result; r.readAsDataURL(f); previewBox.appendChild(img);
    });
  }
  setupPreview(fotoSebelum, previewSebelum, 'Preview sebelum pekerjaan');
  setupPreview(fotoSesudah, previewSesudah, 'Preview sesudah pekerjaan');

  // ====== Utils ======

  const alertBox = document.getElementById('alertBox');

  function alertMsg(type, msg){

    alertBox.innerHTML = '<div class="alert alert-'+type+'">'+msg+'</div>';

  }

  function toDataURL(file){

    return new Promise((resolve, reject)=>{

      if(!file) return resolve("");

      const reader = new FileReader();

      reader.onload = ()=> resolve(reader.result);

      reader.onerror = reject;

      reader.readAsDataURL(file);

    });

  }



  // ====== Submit handler ======

  async function submitForm(e){

    e?.preventDefault?.();



    const nama = document.getElementById('nama').value.trim();

    const nopel = document.getElementById('nopel').value.trim();

    const alamat = document.getElementById('alamat').value.trim();

    const kontak = document.getElementById('kontak').value.trim();

    const jenis = document.getElementById('jenis').value;

    const keterangan = document.getElementById('keterangan').value.trim();



    // ambil dari input yang benar (lat-aduan / lng-aduan)

    const lat = document.getElementById('lat-aduan').value.trim();

    const lng = document.getElementById('lng-aduan').value.trim();

    const lokasi = (lat && lng) ? (lat+','+lng) : "";



    if(!nama || !alamat){

      alertMsg('warning','Nama dan alamat wajib diisi.');

      return;

    }



    const fileSebelum = (fotoSebelum && fotoSebelum.files[0]) || null;
    const fileSesudah = (fotoSesudah && fotoSesudah.files[0]) || null;
    const dokumentasi_sebelum = await toDataURL(fileSebelum); // "" jika kosong
    const dokumentasi_sesudah = await toDataURL(fileSesudah); // "" jika kosong



    const payload = new URLSearchParams({

      nama: nama,

      nopelanggan: nopel,

      alamat: alamat,

      kontak: kontak,

      jenis: jenis,

      keterangan: keterangan,

      lokasi: lokasi,

      // Backward-compat: gunakan 'dokumentasi' = sesudah
      dokumentasi: dokumentasi_sesudah

    });

    // Tambahan field eksplisit
    if (dokumentasi_sebelum) payload.append('dokumentasi_sebelum', dokumentasi_sebelum);
    if (dokumentasi_sesudah) payload.append('dokumentasi_sesudah', dokumentasi_sesudah);



    try{

      alertMsg('info','Mengirim...');

      const resp = await fetch(GAS_URL, {

        method: 'POST',

        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },

        body: payload.toString()

      });

      const json = await resp.json();

      if(json.status === 'success'){

        alertMsg('success', 'Aduan terkirim! Tiket: <strong>'+json.ticket+'</strong>');

        setTimeout(()=> location.href = 'pengaduan-input-gas.html', 800);

      } else {

        alertMsg('danger', 'Gagal: '+(json.message||'Unknown error'));

      }

    } catch(err){

      console.error(err);

      alertMsg('danger','Error jaringan/CORS. Pastikan URL Apps Script benar & Web App access = Anyone.');

    }

  }



  // pasang listener tombol

  const btnKirim = document.getElementById('btnKirim');

  if (btnKirim) {

    // pastikan ini tombol biasa, bukan submit form

    btnKirim.setAttribute('type', 'button');

    btnKirim.addEventListener('click', submitForm);

  }

});

</script>



  <!-- Mobile Bottom Nav (visible only on small screens) -->
  <nav class="mobile-nav d-sm-none">
    <a href="index.html" class="active" aria-label="Home"><i class="fas fa-house"></i></a>
    <a href="peta.html" aria-label="Peta"><i class="fas fa-map"></i></a>
    <a href="Layanan.html" aria-label="Pengaduan"><i class="fas fa-bullhorn"></i></a>
    <a href="tekanan.html" aria-label="Logger"><i class="fas fa-gauge-high"></i></a>
  </nav>

</body>

</html>

