<!DOCTYPE html>

<html lang="id">

<head>

  <meta charset="UTF-8"/>

  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>perumdatirtaweningwilayah6.com</title>



  <!-- libs -->

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous">  function openMixDetail(r){
    const photosTek = parsePhotos(r.fotoTeknisi||'');
    const photosAdu = parsePhotos(r.fotoAduan||'');
    const grid = (arr, label)=> arr.length ? (`<div class="mb-2"><div class="small text-secondary">${label}</div><div class="photo-grid">` + arr.map(u=>`<a href="${u}" target="_blank" rel="noopener"><img src="${u}" alt="${label}"/></a>`).join('') + `</div></div>`) : '';
    const mapHtml = r.lokasi && r.lokasi.includes(',') ? `<a href="https://www.google.com/maps?q=${encodeURIComponent(r.lokasi)}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-map-location-dot me-1"></i> Buka Maps</a>` : '<span class="text-secondary">Lokasi tidak tersedia</span>';
    document.getElementById('detailBody').innerHTML = `
      <div class="mb-2"><strong>Tiket:</strong> ${r.tiket||'-'}</div>
      <div class="mb-2"><strong>Pelanggan:</strong> ${r.nama||'-'} ${r.nopel?('<small class="text-secondary">('+r.nopel+')</small>'):''}</div>
      <div class="mb-2"><strong>Teknisi/Tim:</strong> ${(r.teknisi||'-')} ${r.tim?('<small class="text-secondary">('+r.tim+')</small>'):''}</div>
      <div class="mb-2"><strong>Waktu:</strong> ${fmtWIB(r.waktu)||'-'}</div>
      <div class="mb-2"><strong>Lokasi:</strong> ${r.lokasi||'-'} ${mapHtml}</div>
      ${grid(photosAdu,'Foto Pengaduan')}
      ${grid(photosTek,'Foto Teknisi')}
      ${(!photosTek.length && !photosAdu.length) ? '<em class="text-secondary">Tidak ada foto</em>' : ''}
    `;
    const modalEl = document.getElementById('detailModal');
    new bootstrap.Modal(modalEl).show();
    setTimeout(()=>{
      document.querySelectorAll('#detailBody .photo-grid img').forEach(img=>{
        img.addEventListener('error', ()=>{
          const u = img.getAttribute('src') || '#';
          const a = document.createElement('a'); a.href=u; a.target='_blank'; a.rel='noopener'; a.className='btn btn-sm btn-outline-light w-100'; a.textContent='Buka Link Foto'; img.replaceWith(a);
        }, { once:true });
      });
    },0);
  }
</script>

  <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet"/>



  <style>

    :root { --brand:#4db8ff; --ink:#cfeaff; --panel: rgba(16, 40, 78, 0.85); --panel-soft: rgba(16, 40, 78, 0.65); }

    body { background:#0b1f3b; color:#fff; font-family:'Segoe UI',sans-serif; min-height:100vh; }

    .navbar { background: rgba(11,31,59,.7); box-shadow: 0 2px 10px rgba(0,0,0,.4); backdrop-filter: blur(10px); }

    .navbar-brand { color: var(--brand) !important; font-weight: 700; letter-spacing:.3px; }

    .app { display:grid; grid-template-columns: 1fr; gap:16px; padding:16px; }

    .sidebar { background: var(--panel); border-radius:16px; padding:12px; height: calc(100vh - 86px); position: sticky; top:70px; display:flex; flex-direction:column; overflow:hidden; }
    /* Hide sidebar menu entirely */
    .sidebar{ display:none !important; }

    .sidebar-body { flex:1 1 auto; overflow-y:auto; }

    .sidebar-footer { margin-top:auto; }

    .content 

    .card { background: var(--panel); border:none; border-radius:16px; color:#fff; }

    .card-header { background: var(--panel-soft); color: var(--ink); border-bottom: 1px solid rgba(255,255,255,.08); }

    .btn-brand { background: var(--brand); color:#07263f; border: none; }

    .form-control, .form-select { background: rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.15); }

    .form-control::placeholder { color:#cfeaff; opacity:.6; }

    a { color: var(--ink); }

    .nav-pills .nav-link { color:#cfeaff; }

    .nav-pills .nav-link.active { background: var(--brand); color:#07263f; font-weight:600; }

    .kpi { display:flex; align-items:center; gap:12px; }

    .kpi .icon { width:42px; height:42px; border-radius:12px; background: var(--panel-soft); display:flex; align-items:center; justify-content:center; }

    .kpi .num { font-size:1.6rem; font-weight:700; }

    .table thead th { white-space: nowrap; }

    .badge-status { font-weight:600; }

    .badge-status.Baru { background:#6c757d; }

    .badge-status.Proses { background:#17a2b8; }

    .badge-status.Selesai { background:#28a745; }

    /* Skeleton loader */

    .skel { position: relative; overflow: hidden; background: rgba(255,255,255,.08); border-radius:4px; }

    .skel::after { content:""; position:absolute; inset:0; transform: translateX(-100%); background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.18), rgba(255,255,255,0)); animation: shimmer 1.2s infinite; }

    @keyframes shimmer { 100% { transform: translateX(100%); } }

    /* Toast tweak for dark theme */

    .toast.text-bg-success, .toast.text-bg-danger, .toast.text-bg-info, .toast.text-bg-warning { box-shadow: 0 8px 24px rgba(0,0,0,.4); }

    /* Photo grid for detail modal */

    .photo-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap:8px; }

    .photo-grid img { width:100%; height:120px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,255,255,.25); }

    /* Smaller thumbnails in detail modal */
    #detailBody .photo-grid { grid-template-columns: repeat(auto-fill, minmax(80px,1fr)); }
    #detailBody .photo-grid img { height:80px; }

    /* Table tweaks for Mix */
    .col-fit { width:1%; white-space:nowrap; }
    #mixTb td, #mixTb th { vertical-align: middle; }
    #tabMix table td:nth-child(8),
    #tabMix table th:nth-child(8),
    #tabMix table td:nth-child(9),
    #tabMix table th:nth-child(9),
    #tabMix table td:nth-child(10),
    #tabMix table th:nth-child(10) { text-align: center; }

    /* Only show search inline; hide advanced filters */
    #tabMix .advanced-filters { display:none !important; }
    #tabMix table { font-size: .92rem; }
    #tabMix td, #tabMix th { padding-top: .35rem; padding-bottom: .35rem; }
    .trunc-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }

    /* Compact location picker for input modal */
    .loc-compact .btn{ width:100%; text-align:left; }
    .loc-compact .hint{ font-size:.9rem; color:#cfeaff; }
    .loc-compact .stat{ font-size:.9rem; color:#cfeaff; }

  </style>
  <link rel="stylesheet" href="css/responsive.css" />
  
  
  </head>

<body>

  <nav class="navbar navbar-dark px-3">

    <a class="navbar-brand d-flex align-items-center" href="#">

      <img src="https://perumdatirtawening.co.id/asset/image/logo-horizon-kecils.gif" height="42" class="me-2" alt="Logo"/>

    </a>

    <div class="ms-auto d-flex align-items-center gap-2">

      <button class="btn btn-sm btn-brand" id="btnOpenInput"><i class="fas fa-file-circle-plus me-1"></i>Input Pengaduan</button>

      <button class="btn btn-sm btn-outline-info" id="btnSettings"><i class="fas fa-gear me-1"></i>Settings</button>

      <button class="btn btn-sm btn-outline-danger" id="btnLogout"><i class="fas fa-right-from-bracket me-1"></i>Logout</button>

    </div>

  </nav>



  <div class="app container-fluid">

    <!-- SIDEBAR -->

    <aside class="sidebar">

  <div class="sidebar-body">

    <div class="mb-2 text-secondary small">Menu</div>

    <div class="nav nav-pills flex-column gap-1" id="menu">

      <button class="nav-link active" data-target="#tabOverview"><i class="fas fa-chart-pie me-2"></i>Overview</button>

      <button class="nav-link" data-target="#tabAduan"><i class="fas fa-ticket me-2"></i>Pengaduan</button>

      <button class="nav-link" data-target="#tabTeknisi"><i class="fas fa-screwdriver-wrench me-2"></i>Data Teknisi</button>

      <button class="nav-link" data-target="#tabUsers"><i class="fas fa-users me-2"></i>Users Teknisi</button>

    </div>

  </div>

  <div class="sidebar-footer">

    <hr class="border-secondary opacity-25"/>

    <div class="small text-secondary">Â© 2025 Prumda Tirtawening wilayah 6.</div>

  </div>

</aside>



    <!-- CONTENT -->

    <main class="content">

      <!-- OVERVIEW -->

      <section id="tabOverview" class="tab card" data-aos="fade-up">

        <div class="card-header d-flex align-items-center justify-content-between">

          <div class="fw-bold"><i class="fas fa-chart-pie me-2"></i>Ringkasan</div>

          <div>

            <button class="btn btn-sm btn-outline-light" id="btnRefreshAll"><i class="fas fa-rotate me-1"></i>Refresh</button>

          </div>

        </div>

        <div class="card-body">

          <div class="row g-3">

            <div class="col-md-3">

              <div class="card p-3 h-100">

                <div class="kpi">

                  <div class="icon"><i class="fas fa-list"></i></div>

                  <div>

                    <div class="num" id="kpiTotalAduan">-</div>

                    <div class="text-secondary small">Total Tiket</div>

                  </div>

                </div>

              </div>

            </div>

            <div class="col-md-3">

              <div class="card p-3 h-100">

                <div class="kpi">

                  <div class="icon"><i class="fas fa-hourglass-half"></i></div>

                  <div>

                    <div class="num" id="kpiAduanProses">-</div>

                    <div class="text-secondary small">Tiket Proses</div>

                  </div>

                </div>

              </div>

            </div>

            <div class="col-md-3">

              <div class="card p-3 h-100">

                <div class="kpi">

                  <div class="icon"><i class="fas fa-check-circle"></i></div>

                  <div>

                    <div class="num" id="kpiAduanSelesai">-</div>

                    <div class="text-secondary small">Tiket Selesai</div>

                  </div>

                </div>

              </div>

            </div>

            <div class="col-md-3">

              <div class="card p-3 h-100">

                <div class="kpi">

                  <div class="icon"><i class="fas fa-clipboard-check"></i></div>

                  <div>

                    <div class="num" id="kpiTeknisiRows">-</div>

                    <div class="text-secondary small">Laporan Teknisi</div>

                  </div>

                </div>

              </div>

            </div>

          </div>

          <div class="mt-3 small text-secondary">

            <i class="fas fa-circle-info me-1"></i>Angka dihitung dari data yang diambil langsung dari Google Apps Script (GAS).

          </div>

        </div>

      </section>



      <!-- PENGADUAN -->

      <section id="tabAduan" class="tab card d-none" data-aos="fade-up">

        <div class="card-header fw-bold"><i class="fas fa-ticket me-2"></i>Daftar Pengaduan</div>

        <div class="card-body">

          <div class="row g-2 align-items-end mb-3 mix-inline-filters">

            <div class="col-md-4">

              <label class="form-label">Pencarian</label>

              <input id="aduanQ" class="form-control" placeholder="Nama/Alamat/Tiket"/>

            </div>

            <div class="col-md-3">

              <label class="form-label">Status</label>

              <select id="aduanStatus" class="form-select">

                <option value="">Semua</option>

                <option>Baru</option>

                <option>Proses</option>

                <option>Selesai</option>

              </select>

            </div>

            <div class="col-md-5 d-flex gap-2">

              <button class="btn btn-brand" id="btnAduanApply">Terapkan</button>

              <button class="btn btn-outline-light" id="btnAduanReset">Reset</button>

              <button class="btn btn-outline-light" id="btnAduanReload"><i class="fas fa-rotate"></i></button>

            </div>

          </div>

          <div class="table-responsive">

            <table class="table table-dark table-hover align-middle">

              <thead>

                <tr>

                  <th>#</th><th>Tiket</th><th>Tanggal</th><th>Nama</th><th>Jenis</th><th>Status</th><th>Lokasi</th><th>Aksi</th>

                </tr>

              </thead>

              <tbody id="aduanTb"></tbody>

            </table>

          </div>

          <div class="d-flex justify-content-between mt-2">

            <small id="aduanCount" class="text-secondary"></small>

            <div class="d-flex gap-2">

              <button class="btn btn-outline-light btn-sm" id="aduanPrev">ÃÆÃÂ¢ÃÂ¢Ã¢â¬Å¡ÃÂ¬ÃâÃÂ¹</button>

              <button class="btn btn-outline-light btn-sm" id="aduanNext">ÃÆÃÂ¢ÃÂ¢Ã¢â¬Å¡ÃÂ¬ÃâÃÂº</button>

            </div>

          </div>

        </div>

      </section>



      <!-- DATA TEKNISI -->

      <section id="tabTeknisi" class="tab card d-none" data-aos="fade-up">

        <div class="card-header fw-bold"><i class="fas fa-clipboard-check me-2"></i>Data Teknisi</div>

        <div class="card-body">

          <div class="row g-2 align-items-end mb-3">

            <div class="col-md-4">

              <label class="form-label">Pencarian</label>

              <input id="tekQ" class="form-control" placeholder="Tiket/Teknisi/Tim/Catatan"/>

            </div>

            <div class="col-md-4">

              <label class="form-label">Filter Waktu</label>

              <input id="tekQtime" class="form-control" placeholder="yyyy-mm / teks bebas"/>

            </div>

            <div class="col-md-4 d-flex gap-2">

              <button class="btn btn-brand" id="btnTekApply">Terapkan</button>

              <button class="btn btn-outline-light" id="btnTekExport">Ekspor CSV</button>

              <button class="btn btn-outline-light" id="btnTekReload"><i class="fas fa-rotate"></i></button>

            </div>

          </div>

          <div class="table-responsive">

            <table class="table table-dark table-hover align-middle">

              <thead>

                <tr>

                  <th>#</th>

                  <th>Tiket</th>

                  <th>Teknisi / Tim</th>

                  <th>Waktu Selesai</th>

                  <th>Catatan</th>

                  <th>Lokasi</th>

                  <th>Aksi</th>

                </tr>

              </thead>

              <tbody id="tekTb"></tbody>

            </table>

          </div>

          <div class="d-flex justify-content-between mt-2">

            <small id="tekCount" class="text-secondary"></small>

            <div class="d-flex gap-2">

              <button class="btn btn-outline-light btn-sm" id="tekPrev">ÃÆÃÂ¢ÃÂ¢Ã¢â¬Å¡ÃÂ¬ÃâÃÂ¹</button>

              <button class="btn btn-outline-light btn-sm" id="tekNext">ÃÆÃÂ¢ÃÂ¢Ã¢â¬Å¡ÃÂ¬ÃâÃÂº</button>

            </div>

          </div>

        </div>

      </section>



      <!-- GABUNGAN: Aduan + Teknisi Selesai -->

      <section id="tabMix" class="tab card" data-aos="fade-up">

        <div class="card-header fw-bold"><i class="fas fa-layer-group me-2"></i>Gabungan Aduan + Teknisi (Selesai)</div>

        <div class="card-body">

          <div class="row g-2 align-items-end mb-3">

            <div class="col-md-6">

              <input id="mixQ" class="form-control" placeholder="Cari tiket/nama/teknisi/alamat/jenis"/>

            </div>

            <div class="col-md-6 d-flex gap-3 align-items-center advanced-filters">

              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="mixOnlyDone" checked>
                <label for="mixOnlyDone" class="form-check-label">Hanya yang selesai (atau punya laporan teknisi)</label>
              </div>

              <div class="d-flex align-items-center gap-2">
                <label for="mixSort" class="small text-secondary mb-0">Urutkan</label>
                <select id="mixSort" class="form-select form-select-sm" style="width:auto; min-width: 160px;">
                  <option value="desc" selected>Terbaru dulu</option>
                  <option value="asc">Terlama dulu</option>
                </select>
              </div>

              <button class="btn btn-outline-light" id="btnMixReload"><i class="fas fa-rotate"></i></button>

            </div>

          </div>

          <div class="table-responsive">

            <table class="table table-dark table-hover table-sm align-middle">

              <thead>
                <tr>
                  <th>#</th>
                  <th class="text-nowrap">Waktu</th>
                  <th class="text-nowrap">Tiket</th>
                  <th>Pelanggan</th>
                  <th>Teknisi/Tim</th>
                  <th>Jenis</th>
                  <th>Status</th>
                  <th class="text-center col-fit">Lokasi</th>
                  <th class="text-center col-fit">Foto</th>
                  <th class="text-center col-fit">Aksi</th>
                </tr>
              </thead>
              <tbody id="mixTb"></tbody>
            </table>

          </div>

          <div class="d-flex justify-content-between mt-2">
            <small id="mixCount" class="text-secondary"></small>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-light btn-sm" id="mixPrev">&lsaquo;</button>
              <button class="btn btn-outline-light btn-sm" id="mixNext">&rsaquo;</button>
            </div>
          </div>

        </div>

      </section>



      <!-- USERS TEKNISI -->

<section id="tabUsers" class="tab card" data-aos="fade-up">

  <div class="card-header fw-bold">

    <i class="fas fa-users me-2"></i>Users Teknisi

  </div>

  <div class="card-body">

    <div class="row g-2 align-items-end mb-2">

      <div class="col-md-6">

        <input id="userQ" class="form-control" placeholder="Cari nama/email"/>

      </div>

      <div class="col-md-6 d-flex gap-2">

        <button class="btn btn-brand" id="btnUserApply">Terapkan</button>

        <button class="btn btn-outline-light" id="btnUserReload">

          <i class="fas fa-rotate"></i>

        </button>

      </div>

    </div>



    <div class="table-responsive">

      <table class="table table-dark table-hover align-middle">

        <thead>

          <tr>

            <th>#</th>

            <th>Nama</th>

            <th>Email</th>

            <th>Status</th>

            <th>Aksi</th>

          </tr>

        </thead>

        <tbody id="userTb"></tbody>

      </table>

    </div>

    <small id="userCount" class="text-secondary"></small>

  </div>

</section>





  <!-- Modal Detail Teknisi -->

  <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">

    <div class="modal-dialog modal-lg modal-dialog-centered">

      <div class="modal-content" style="background: rgba(16, 40, 78, 0.95); color:#fff;">

        <div class="modal-header">

          <h5 class="modal-title"><i class="fas fa-id-card-clip me-2"></i>Detail Pekerjaan Teknisi</h5>

          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Tutup"></button>

        </div>

        <div class="modal-body">

          <div id="detailBody"></div>

        </div>

      </div>

    </div>

  </div>



  <!-- Toast container -->

  <div class="toast-container position-fixed top-0 end-0 p-3" id="toastWrap"></div>

  <!-- Input Pengaduan Modal -->
  <div class="modal fade" id="inputModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" style="background: rgba(16,40,78,.95); color:#fff;">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-file-circle-plus me-2"></i>Input Pengaduan</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <div id="admInputAlert"></div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nama</label>
              <input id="admInNama" class="form-control" placeholder="Nama pelanggan"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">No Langganan</label>
              <input id="admInNopel" class="form-control" placeholder="No Pelanggan"/>
            </div>
            <div class="col-12">
              <label class="form-label">Alamat</label>
              <input id="admInAlamat" class="form-control" placeholder="Alamat lengkap"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">Kontak</label>
              <input id="admInKontak" class="form-control" placeholder="08xxxx"/>
            </div>
            <div class="col-md-6">
              <label class="form-label">Jenis Keluhan</label>
              <select id="admInJenis" class="form-select">
                <option>Air Kecil</option>
                <option>Air Mati</option>
                <option>Kebocoran</option>
                <option>Meter Rusak</option>
                <option>Lainnya</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Keterangan</label>
              <textarea id="admInKet" class="form-control" rows="3" placeholder="Jelaskan keluhan..."></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Set Lokasi</label>
              <div class="row g-2 loc-compact">
                <div class="col-sm-6 col-12 d-grid gap-2">
                  <button id="admInBtnGeo" type="button" class="btn btn-outline-info"><i class="fas fa-location-arrow me-2"></i>Current Location</button>
                  <button id="admInBtnUseMap" type="button" class="btn btn-outline-light"><i class="fas fa-location-dot me-2"></i>Use Map</button>
                  <button id="admInBtnClear" type="button" class="btn btn-outline-secondary"><i class="fas fa-circle-xmark me-2"></i>Clear</button>
                </div>
                <div class="col-sm-6 col-12">
                  <div class="stat">Latitude: <span id="admInLatStat">-</span></div>
                  <div class="stat">Longitude: <span id="admInLngStat">-</span></div>
                  <div class="stat">Accuracy: <span id="admInAccStat">-</span></div>
                  <div class="hint mt-2" id="admInLocHint"></div>
                </div>
              </div>
              <input type="hidden" id="admInLat"/>
              <input type="hidden" id="admInLng"/>
            </div>
            <div class="col-12">
              <label class="form-label">Foto (opsional)</label>
              <input id="admInFoto" type="file" accept="image/*" class="form-control"/>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-light" data-bs-dismiss="modal">Tutup</button>
          <button id="admBtnSubmitInput" class="btn btn-brand" type="button">Kirim</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Map picker for Admin Input -->
  <div class="modal fade modal-fullscreen-sm-down" id="admMapPickModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background: rgba(16,40,78,.96); color:#e6f3ff;">
        <div class="modal-header border-0">
          <h5 class="modal-title"><i class="fas fa-location-dot me-2"></i>Pilih Lokasi</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body pt-0">
          <div id="admMapPick" style="height:70vh; border-radius:12px;"></div>
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-success" id="admBtnMapUseGPS" type="button"><i class="fas fa-location-arrow me-2"></i>Pakai Lokasi Saya</button>
            <button class="btn btn-primary ms-auto" id="admBtnMapSave" type="button"><i class="fas fa-check me-2"></i>Simpan Lokasi</button>
          </div>
        </div>
      </div>
    </div>
  </div>



  <!-- libs -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">  function openMixDetail(r){
    const photosTek = parsePhotos(r.fotoTeknisi||'');
    const photosAdu = parsePhotos(r.fotoAduan||'');
    const grid = (arr, label)=> arr.length ? (`<div class="mb-2"><div class="small text-secondary">${label}</div><div class="photo-grid">` + arr.map(u=>`<a href="${u}" target="_blank" rel="noopener"><img src="${u}" alt="${label}"/></a>`).join('') + `</div></div>`) : '';
    const mapHtml = r.lokasi && r.lokasi.includes(',') ? `<a href="https://www.google.com/maps?q=${encodeURIComponent(r.lokasi)}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-map-location-dot me-1"></i> Buka Maps</a>` : '<span class="text-secondary">Lokasi tidak tersedia</span>';
    document.getElementById('detailBody').innerHTML = `
      <div class="mb-2"><strong>Tiket:</strong> ${r.tiket||'-'}</div>
      <div class="mb-2"><strong>Pelanggan:</strong> ${r.nama||'-'} ${r.nopel?('<small class="text-secondary">('+r.nopel+')</small>'):''}</div>
      <div class="mb-2"><strong>Teknisi/Tim:</strong> ${(r.teknisi||'-')} ${r.tim?('<small class="text-secondary">('+r.tim+')</small>'):''}</div>
      <div class="mb-2"><strong>Waktu:</strong> ${fmtWIB(r.waktu)||'-'}</div>
      <div class="mb-2"><strong>Lokasi:</strong> ${r.lokasi||'-'} ${mapHtml}</div>
      ${grid(photosAdu,'Foto Pengaduan')}
      ${grid(photosTek,'Foto Teknisi')}
      ${(!photosTek.length && !photosAdu.length) ? '<em class="text-secondary">Tidak ada foto</em>' : ''}
    `;
    const modalEl = document.getElementById('detailModal');
    new bootstrap.Modal(modalEl).show();
    setTimeout(()=>{
      document.querySelectorAll('#detailBody .photo-grid img').forEach(img=>{
        img.addEventListener('error', ()=>{
          const u = img.getAttribute('src') || '#';
          const a = document.createElement('a'); a.href=u; a.target='_blank'; a.rel='noopener'; a.className='btn btn-sm btn-outline-light w-100'; a.textContent='Buka Link Foto'; img.replaceWith(a);
        }, { once:true });
      });
    },0);
  }
</script>

  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js">  function openMixDetail(r){
    const photosTek = parsePhotos(r.fotoTeknisi||'');
    const photosAdu = parsePhotos(r.fotoAduan||'');
    const grid = (arr, label)=> arr.length ? (`<div class="mb-2"><div class="small text-secondary">${label}</div><div class="photo-grid">` + arr.map(u=>`<a href="${u}" target="_blank" rel="noopener"><img src="${u}" alt="${label}"/></a>`).join('') + `</div></div>`) : '';
    const mapHtml = r.lokasi && r.lokasi.includes(',') ? `<a href="https://www.google.com/maps?q=${encodeURIComponent(r.lokasi)}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-map-location-dot me-1"></i> Buka Maps</a>` : '<span class="text-secondary">Lokasi tidak tersedia</span>';
    document.getElementById('detailBody').innerHTML = `
      <div class="mb-2"><strong>Tiket:</strong> ${r.tiket||'-'}</div>
      <div class="mb-2"><strong>Pelanggan:</strong> ${r.nama||'-'} ${r.nopel?('<small class="text-secondary">('+r.nopel+')</small>'):''}</div>
      <div class="mb-2"><strong>Teknisi/Tim:</strong> ${(r.teknisi||'-')} ${r.tim?('<small class="text-secondary">('+r.tim+')</small>'):''}</div>
      <div class="mb-2"><strong>Waktu:</strong> ${fmtWIB(r.waktu)||'-'}</div>
      <div class="mb-2"><strong>Lokasi:</strong> ${r.lokasi||'-'} ${mapHtml}</div>
      ${grid(photosAdu,'Foto Pengaduan')}
      ${grid(photosTek,'Foto Teknisi')}
      ${(!photosTek.length && !photosAdu.length) ? '<em class="text-secondary">Tidak ada foto</em>' : ''}
    `;
    const modalEl = document.getElementById('detailModal');
    new bootstrap.Modal(modalEl).show();
    setTimeout(()=>{
      document.querySelectorAll('#detailBody .photo-grid img').forEach(img=>{
        img.addEventListener('error', ()=>{
          const u = img.getAttribute('src') || '#';
          const a = document.createElement('a'); a.href=u; a.target='_blank'; a.rel='noopener'; a.className='btn btn-sm btn-outline-light w-100'; a.textContent='Buka Link Foto'; img.replaceWith(a);
        }, { once:true });
      });
    },0);
  }
</script>

  <script>AOS.init({duration:800, once:true});  function openMixDetail(r){
    const photosTek = parsePhotos(r.fotoTeknisi||'');
    const photosAdu = parsePhotos(r.fotoAduan||'');
    const grid = (arr, label)=> arr.length ? (`<div class="mb-2"><div class="small text-secondary">${label}</div><div class="photo-grid">` + arr.map(u=>`<a href="${u}" target="_blank" rel="noopener"><img src="${u}" alt="${label}"/></a>`).join('') + `</div></div>`) : '';
    const mapHtml = r.lokasi && r.lokasi.includes(',') ? `<a href="https://www.google.com/maps?q=${encodeURIComponent(r.lokasi)}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-map-location-dot me-1"></i> Buka Maps</a>` : '<span class="text-secondary">Lokasi tidak tersedia</span>';
    document.getElementById('detailBody').innerHTML = `
      <div class="mb-2"><strong>Tiket:</strong> ${r.tiket||'-'}</div>
      <div class="mb-2"><strong>Pelanggan:</strong> ${r.nama||'-'} ${r.nopel?('<small class="text-secondary">('+r.nopel+')</small>'):''}</div>
      <div class="mb-2"><strong>Teknisi/Tim:</strong> ${(r.teknisi||'-')} ${r.tim?('<small class="text-secondary">('+r.tim+')</small>'):''}</div>
      <div class="mb-2"><strong>Waktu:</strong> ${fmtWIB(r.waktu)||'-'}</div>
      <div class="mb-2"><strong>Lokasi:</strong> ${r.lokasi||'-'} ${mapHtml}</div>
      ${grid(photosAdu,'Foto Pengaduan')}
      ${grid(photosTek,'Foto Teknisi')}
      ${(!photosTek.length && !photosAdu.length) ? '<em class="text-secondary">Tidak ada foto</em>' : ''}
    `;
    const modalEl = document.getElementById('detailModal');
    new bootstrap.Modal(modalEl).show();
    setTimeout(()=>{
      document.querySelectorAll('#detailBody .photo-grid img').forEach(img=>{
        img.addEventListener('error', ()=>{
          const u = img.getAttribute('src') || '#';
          const a = document.createElement('a'); a.href=u; a.target='_blank'; a.rel='noopener'; a.className='btn btn-sm btn-outline-light w-100'; a.textContent='Buka Link Foto'; img.replaceWith(a);
        }, { once:true });
      });
    },0);
  }
</script>

  <!-- Leaflet for map picker -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>



  <script>

  // ===================== KONFIG =====================

  const CFG = {

    GAS_URL: localStorage.getItem('cfg_gas') || 'https://script\.google\.com/macros/s/AKfycbynOkn3NJuJvI8oE1Cuy83rW479Tod7e1Go72pRRH5F04XLkVpbytAXG3ARg-ZuqTLm0Q/exec',

    PAGE_SIZE: Number(localStorage.getItem('cfg_page')) || 10,

  };

  const _envEl = document.getElementById('envLabel');

  if (_envEl) {

    try { _envEl.textContent = 'GAS: ' + (new URL(CFG.GAS_URL)).hostname; }

    catch { _envEl.textContent = 'GAS: (invalid URL)'; }

  }



  // ===================== AUTH GUARD =====================

  function isAuthed(){ return !!localStorage.getItem('adm_auth'); }

  function logout(){ localStorage.removeItem('adm_auth'); location.href = 'admin-login.html'; }

  document.getElementById('btnLogout').addEventListener('click', logout);

  if (!isAuthed() && !location.pathname.endsWith('admin-login.html')) location.href = 'admin-login.html';



  // ===================== NAV =====================

  document.querySelectorAll('#menu .nav-link').forEach(btn=>{

    btn.addEventListener('click', ()=>{

      document.querySelectorAll('#menu .nav-link').forEach(b=>b.classList.remove('active'));

      btn.classList.add('active');

      const target = btn.getAttribute('data-target');

      document.querySelectorAll('.tab').forEach(s=>s.classList.add('d-none'));

      document.querySelector(target).classList.remove('d-none');

    });

  });



  // ===================== UTIL =====================

  const escCsv = x => `"${(x??'').toString().replace(/"/g,'""')}"`;

  const mapLink = latlng => latlng && latlng.includes(',') ? `<a href="https://www.google.com/maps?q=${encodeURIComponent(latlng)}" target="_blank" title="${latlng}">ÃÆÃÂ°Ãâ¦ÃÂ¸ÃÂ¢Ã¢âÂ¬ÃâÃâÃÂ</a>` : '';

  const escHtml = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

  const safeUrl = u => (typeof u === 'string' && /^https?:\/\//i.test(u)) ? u : '';

  // Fix garbled labels from encoding issues (runtime patch)
  function fixNavButtons(){
    const set = (id, html)=>{ const el = document.getElementById(id); if (el) el.innerHTML = html; };
    set('aduanPrev','&lsaquo;'); set('aduanNext','&rsaquo;');
    set('tekPrev','&lsaquo;'); set('tekNext','&rsaquo;');
  }

  // Replace any Google Maps link text with an icon to avoid weird characters
  function fixMapLinks(){
    document.querySelectorAll('a[href^="https://www.google.com/maps"]').forEach(a=>{ a.innerHTML = '<i class="fas fa-location-dot"></i>'; });
  }

  // Normalize photo buttons label (if any garbled text present)
  function fixPhotoButtons(){
    document.querySelectorAll('button.open-photo').forEach(btn=>{
      const idx = Number(btn.getAttribute('data-idx'))||0;
      try{
        const r = (window.state && window.state.tek && window.state.tek.data) ? window.state.tek.data[idx] : null;
        const pc = r ? (Array.from(String(r.foto||'').matchAll(/href\s*=\s*"([^"]+)"/ig)).length || String(r.foto||'').split(/[\s,;\n]+/).filter(Boolean).length) : '';
        btn.innerHTML = '<i class="fas fa-image me-1"></i>' + 'Lihat Foto' + (pc?(' x'+pc):'');
      }catch{ btn.innerHTML = '<i class="fas fa-image me-1"></i>Lihat Foto'; }
    });
  }

  const parseDate = (v)=> {

    // Try common formats: "yyyy-mm-dd hh:mm:ss" or "dd/mm/yyyy hh:mm"

    if(!v) return 0;

    const s = String(v).trim();

    const d = new Date(s);

    if(!isNaN(d)) return d.getTime();

    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);

    if(m) return new Date(`${m[1]}-${m[2]}-${m[3]}`).getTime();

    const m2 = s.match(/^(\d{2})[\/-](\d{2})[\/-](\d{4})/);

    if(m2) return new Date(`${m2[3]}-${m2[2]}-${m2[1]}`).getTime();

    return 0;

  };

  // Format a date/time value to Asia/Jakarta (WIB)
  function fmtWIB(v){
    try{
      let ms = 0;
      if (typeof v === 'number') { ms = v; }
      else { ms = parseDate(v); if (!ms && v) { const d=new Date(String(v)); if(!isNaN(d)) ms=d.getTime(); } }
      if (!ms) return v || '';
      const d = new Date(ms);
      const parts = new Intl.DateTimeFormat('id-ID', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'Asia/Jakarta' }).formatToParts(d).reduce((a,p)=>{ a[p.type]=p.value; return a; },{});
      const pad = s => String(s).padStart(2,'0');
      return `${parts.year}-${pad(parts.month)}-${pad(parts.day)} ${pad(parts.hour)}:${pad(parts.minute)} WIB`;
    }catch{ return v || ''; }
  }



  // Toast helper (Bootstrap 5)

  function notify(type, msg){

    const wrap = document.getElementById('toastWrap');

    const el = document.createElement('div');

    const tone = type==='error' ? 'danger' : (type||'info');

    el.className = `toast align-items-center text-bg-${tone} border-0`;

    el.setAttribute('role','alert');

    el.innerHTML = `<div class="d-flex"><div class="toast-body">${escHtml(msg)}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;

    wrap.appendChild(el);

    const t = new bootstrap.Toast(el, { delay: 3500 });

    t.show();

    el.addEventListener('hidden.bs.toast', ()=> el.remove());

  }



  // Skeleton table helper

  function setTableLoading(tbodyId, colCount){

    const tb = document.getElementById(tbodyId);

    if(!tb) return;

    const rows = Math.min(CFG.PAGE_SIZE, 10);

    const widths = [24,80,120,100,80,60,40,100];

    tb.innerHTML = Array.from({length:rows}).map(()=>

      `<tr>` + Array.from({length:colCount}).map((_,i)=> `<td><div class="skel" style="height:12px;width:${widths[i%widths.length]}px"></div></td>`).join('') + `</tr>`

    ).join('');

  }



  // Normalize Google Drive links to direct-view URLs

  function normalizeDriveUrl(u){

    try{

      const url = new URL(u);

      if(url.hostname.includes('drive.google.com')){

        // case: /file/d/<id>/view

        const m = url.pathname.match(/\/file\/d\/([^/]+)\//);

        if(m && m[1]) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

        // case: open?id=<id> or uc?id=<id>

        const id = url.searchParams.get('id');

        if(id) return `https://drive.google.com/uc?export=view&id=${id}`;

      }

    }catch{}

    return u;

  }



  function parsePhotos(s){

    if(!s) return [];

    const str = String(s);

    // If HTML anchor provided, extract href(s)

    const hrefs = Array.from(str.matchAll(/href\s*=\s*"([^"]+)"/ig)).map(m=>m[1]);

    const base = hrefs.length ? hrefs.join(',') : str;

    const raw = String(base)

      .split(/\s*[,\n;]\s*|\s{2,}/) // split by comma/newline/long spaces

      .map(x=>x.trim())

      .filter(Boolean);

    const urls = [];

    for(const r of raw){

      const n = normalizeDriveUrl(r);

      if(/^https?:\/\//i.test(n)) urls.push(n);

    }

    // dedupe

    return Array.from(new Set(urls));

  }



  // pick(): ambil nilai dari beberapa kemungkinan nama kolom

  function pick(o, names){

    for (const n of names) if (o[n] != null && String(o[n]).trim() !== "") return String(o[n]);

    const keys = Object.keys(o);

    for (const n of names){ const k = keys.find(k => k.toLowerCase() === n.toLowerCase()); if (k && o[k] != null && String(o[k]).trim() !== "") return String(o[k]); }

    return "";

  }



  // ===================== FETCHERS =====================

  async function fetchAduan(){

    const url = CFG.GAS_URL + '?mode=aduan';

    const resp = await fetch(url);

    if(!resp.ok) throw new Error('HTTP '+resp.status);

    const list = await resp.json();



    const mapped = list.map(o=>({

      tiket:o["Tiket"],

      tanggal:o["Tanggal"],

      jenis:o["Jenis Keluhan"],

      nopel:o["Nomor Pelanggan"],

      nama:o["Nama Pelanggan"],

      alamat:o["Alamat"],

      kontak:o["Kontak"],

      ket:o["Keterangan"],

      lokasi:o["Lokasi"],

      foto:o["Dokumentasi Pengaduan"],

      status:o["Status"],

    }));



    // sort terbaru di atas (by Tanggal)

    mapped.sort((a,b)=> parseDate(b.tanggal) - parseDate(a.tanggal));

    return mapped;

  }



  async function updateAduanStatus(tiket, status){

    const url = CFG.GAS_URL + '?mode=update&tiket=' + encodeURIComponent(tiket) + '&status=' + encodeURIComponent(status);

    const resp = await fetch(url);

    const json = await resp.json();

    if(json.status !== 'success') throw new Error(json.message || 'Gagal update');

    return true;

  }



  async function fetchTeknisi(){

    const resp = await fetch(CFG.GAS_URL + '?mode=teknisi');

    if(!resp.ok) throw new Error('HTTP '+resp.status);

    const list = await resp.json();

    const mapped = list.map(o=>({

      ts     : pick(o, ["Timestamp","Waktu Input","Created At","ts"]),

      tiket  : pick(o, ["Tiket","No Tiket","tiket"]),

      teknisi: pick(o, ["Teknisi","Nama Teknisi","teknisi"]),

      tim    : pick(o, ["Tim/Rayon","Tim","Rayon","tim"]),

      catatan: pick(o, ["Catatan","Keterangan","Deskripsi","catatan"]),

      lokasi : pick(o, ["Lokasi (lat,lng)","Lokasi","Koordinat","lokasi"]),

      waktu  : pick(o, ["Waktu Selesai","Waktu","Selesai","waktu"]),

      foto   : pick(o, ["Foto Hasil","Foto","Dokumentasi","dokumentasi"])

    }));

    // sort terbaru di atas (by waktu/ts)

    mapped.sort((a,b)=> (parseDate(b.waktu)||parseDate(b.ts)) - (parseDate(a.waktu)||parseDate(a.ts)));

    return mapped;

  }



  // Users Teknisi

  async function fetchUsers(){

    const parseUsers = (raw)=>{

      const arr = Array.isArray(raw) ? raw

                : Array.isArray(raw?.data) ? raw.data

                : Array.isArray(raw?.users) ? raw.users

                : [];

      const pickAny = (o, keys)=>{

        if(!o) return '';

        for(const key of keys){

          if(o[key] != null && String(o[key]).trim() !== '') return o[key];

          const exact = Object.keys(o).find(k => k.toLowerCase() === String(key).toLowerCase());

          if(exact && o[exact] != null && String(o[exact]).trim() !== '') return o[exact];

        }

        return '';

      };

      return arr.map(r=>{

        const email = String(pickAny(r, ['Email','email','E-mail','mail'])).trim().toLowerCase();

        const nama  = String(pickAny(r, ['Nama','name','Nama Teknisi','nama'])).trim();

        let statusRaw = (r && (r.Status ?? r.status ?? r.Approved ?? r.approved ?? ''));

        let status = '';

        if(typeof statusRaw === 'boolean') status = statusRaw ? 'approved' : 'disabled';

        else status = String(statusRaw||'').trim().toLowerCase() || 'pending';

        return { email, nama, status };

      }).filter(u => u.email || u.nama);

    };

    try{

      // Primary mode

      let resp = await fetch(CFG.GAS_URL + '?mode=teknisi_users');

      if(!resp.ok) throw new Error('HTTP '+resp.status);

      let json = await resp.json();

      let users = parseUsers(json);

      // Fallbacks if empty or different mode name

      if(users.length === 0){

        const modes = ['teknisi_user_list','users_teknisi','users'];

        for(const m of modes){

          try{

            resp = await fetch(CFG.GAS_URL + '?mode=' + m);

            if(!resp.ok) continue;

            json = await resp.json();

            users = parseUsers(json);

            if(users.length) break;

          }catch{ /* ignore and try next */ }

        }

      }

      return users;

    }catch(e){

      console.error('fetchUsers error', e);

      return [];

    }

  }



  async function postAction(params){

    const resp = await fetch(CFG.GAS_URL, {

      method:'POST',

      headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},

      body: new URLSearchParams(params).toString()

    });

    try{ return await resp.json(); }catch{ return {status:'error'}; }

  }



  // ===================== STATE =====================

  const state = {

    aduan: { data:[], idx:0 },

    tek  : { data:[], idx:0 },

    mix  : { data:[], idx:0 },

    users: { data:[] },

  };



  // ===================== RENDERERS =====================

  function renderOverview(){

    const total = state.aduan.data.length;

    const proses = state.aduan.data.filter(x=>x.status==='Proses').length;

    const selesai = state.aduan.data.filter(x=>x.status==='Selesai').length;

    const tekRows = state.tek.data.length;

    document.getElementById('kpiTotalAduan').textContent = total;

    document.getElementById('kpiAduanProses').textContent = proses;

    document.getElementById('kpiAduanSelesai').textContent = selesai;

    document.getElementById('kpiTeknisiRows').textContent = tekRows;

  }



  function aduanFiltered(){

    const q = (document.getElementById('aduanQ').value||'').toLowerCase();

    const fs = document.getElementById('aduanStatus').value;

    return state.aduan.data.filter(r=>{

      const hit = (r.nama||'').toLowerCase().includes(q) || (r.alamat||'').toLowerCase().includes(q) || (r.tiket||'').toLowerCase().includes(q);

      const sOK = !fs || r.status===fs; 

      return hit && sOK;

    });

  }

  function renderAduan(){

    const rows = aduanFiltered();

    const start = state.aduan.idx * CFG.PAGE_SIZE;

    const items = rows.slice(start, start + CFG.PAGE_SIZE);

    const badge = s => `<span class="badge badge-status ${s}">${s}</span>`;

    document.getElementById('aduanTb').innerHTML = items.map((r,i)=>`

      <tr>

        <td>${start+i+1}</td>

        <td><strong>${r.tiket||''}</strong></td>

        <td>${fmtWIB(r.tanggal)||''}</td>

        <td>${r.nama||''}<br><small class="text-secondary">${r.nopel||''}</small></td>

        <td>${r.jenis||''}</td>

        <td>${badge(r.status||'')}</td>

        <td>${r.lokasi?`<a href="https://www.google.com/maps?q=${encodeURIComponent(r.lokasi)}" target="_blank">ÃÆÃÂ°Ãâ¦ÃÂ¸ÃÂ¢Ã¢âÂ¬ÃâÃâÃÂ</a>`:''}</td>

        <td>

          <div class="btn-group btn-group-sm">

            <button class="btn btn-outline-light" onclick="handleSetStatus('${r.tiket}','Proses')">Proses</button>

            <button class="btn btn-outline-light" onclick="handleSetStatus('${r.tiket}','Selesai')">Selesai</button>

          </div>

        </td>

      </tr>`).join('');

    document.getElementById('aduanCount').textContent = `Menampilkan ${rows.length?start+1:0}-${Math.min(start+CFG.PAGE_SIZE, rows.length)} dari ${rows.length} tiket`;

  }

  async function handleSetStatus(tiket, status){

    if(!confirm(`Ubah status tiket ${tiket} menjadi ${status}?`)) return;

    try{ await updateAduanStatus(tiket, status); await loadAduan(); alert('Status berhasil diupdate'); }

    catch(e){ alert('Gagal update: '+e.message); }

  }



  function tekFiltered(){

    const qv = (document.getElementById('tekQ').value||'').toLowerCase();

    const qt = (document.getElementById('tekQtime').value||'').toLowerCase();

    return state.tek.data.filter(r=>{

      const hitText = (r.tiket||'').toLowerCase().includes(qv) || (r.teknisi||'').toLowerCase().includes(qv) || (r.tim||'').toLowerCase().includes(qv) || (r.catatan||'').toLowerCase().includes(qv);

      const hitTime = !qt || (r.waktu||'').toLowerCase().includes(qt) || (r.ts||'').toLowerCase().includes(qt);

      return hitText && hitTime;

    });

  }

  function renderTek(){

    const rows = tekFiltered();

    const start = state.tek.idx * CFG.PAGE_SIZE;

    const items = rows.slice(start, start + CFG.PAGE_SIZE);

    document.getElementById('tekTb').innerHTML = items.map((r,i)=>{

      const idx = start + i;

      const pCount = parsePhotos(r.foto).length;

      const photoCell = pCount > 0

        ? `<button type="button" class="btn btn-sm btn-outline-info open-photo" data-idx="${idx}" title="Lihat Foto">ÃÆÃÂ°Ãâ¦ÃÂ¸ÃÂ¢Ã¢âÂ¬ÃâÃâÃÂ¸ x${pCount}</button>`

        : '-';

      return `

      <tr class="clickable-row" data-idx="${idx}">

        <td>${idx+1}</td>

        <td><strong>${r.tiket||''}</strong></td>

        <td>${r.teknisi||'-'}<br><small class="text-secondary">${r.tim||''}</small></td>

        <td>${fmtWIB(r.waktu||r.ts)||''}</td>

        <td>${r.catatan||''}</td>

        <td>${mapLink(r.lokasi)}</td>

        <td>${photoCell}</td>

      </tr>`;

    }).join('');

    document.getElementById('tekCount').textContent = `Menampilkan ${rows.length?start+1:0}-${Math.min(start+CFG.PAGE_SIZE, rows.length)} dari ${rows.length} data`;

    document.querySelectorAll('#tekTb .clickable-row').forEach(tr=>{

      tr.addEventListener('click', ()=>{

        const idx = Number(tr.getAttribute('data-idx'));

        openDetail(tekFiltered()[idx]);

      });

    });

    document.querySelectorAll('#tekTb .open-photo').forEach(btn=>{

      btn.addEventListener('click', (e)=>{

        e.stopPropagation();

        const idx = Number(btn.getAttribute('data-idx'));

        openDetail(tekFiltered()[idx], true);

      });

    });

  }

  // Wrap renderers to apply post-fix for garbled labels/icons
  const __renderAduan = renderAduan; renderAduan = function(){ __renderAduan(); try{ fixMapLinks(); }catch{} };
  const __renderTek   = renderTek;   renderTek   = function(){ __renderTek();   try{ fixMapLinks(); fixPhotoButtons(); }catch{} };

  // ===== Gabungan (Aduan + Teknisi selesai) =====
  function buildMix(){
    const byTiketTek = new Map();
    for(const r of state.tek.data){ if(r && r.tiket){
      const cur = byTiketTek.get(r.tiket);
      const curTs = cur ? (parseDate(cur.waktu)||parseDate(cur.ts)||0) : 0;
      const nxtTs = (parseDate(r.waktu)||parseDate(r.ts)||0);
      if(!cur || nxtTs >= curTs) byTiketTek.set(r.tiket, r);
    } }

    const rows = [];
    const byTiketAduan = new Set();

    for(const a of state.aduan.data){
      const t = a && a.tiket ? byTiketTek.get(a.tiket) : null;
      byTiketAduan.add(a.tiket);
      rows.push({
        tiket: a.tiket||'',
        waktu: t?.waktu || a.tanggal || t?.ts || '',
        nama: a.nama||'',
        nopel: a.nopel||'',
        teknisi: t?.teknisi||'',
        tim: t?.tim||'',
        jenis: a.jenis||'',
        status: a.status|| (t?'Selesai':''),
        lokasi: t?.lokasi || a.lokasi || '',
        ketAduan: a.ket || '',
        catatan: t?.catatan || '',
        fotoTeknisi: t?.foto || '',
        fotoAduan: a.foto || ''
      });
    }

    // add teknisi rows that might not have matching aduan
    for(const [tk, t] of byTiketTek){
      if(!byTiketAduan.has(tk)){
        rows.push({
          tiket: tk,
          waktu: t.waktu || t.ts || '',
          nama: '', nopel:'',
          teknisi: t.teknisi||'', tim: t.tim||'',
          jenis: '', status: 'Selesai',
          lokasi: t.lokasi||'',
          ketAduan: '',
          catatan: t.catatan||'',
          fotoTeknisi: t.foto||'',
          fotoAduan: ''
        });
      }
    }

    // sort newest first by waktu
    rows.sort((a,b)=> (parseDate(b.waktu)||0) - (parseDate(a.waktu)||0));
    state.mix.data = rows;
  }

  // Helpers for date filtering (WIB)
  function toDateKeyWIB(v){
    try{
      let ms = 0;
      if (typeof v === 'number') ms = v; else { ms = parseDate(v); if(!ms && v){ const d=new Date(String(v)); if(!isNaN(d)) ms=d.getTime(); } }
      if(!ms) return '';
      const d = new Date(ms);
      const parts = new Intl.DateTimeFormat('id-ID', { year:'numeric', month:'2-digit', day:'2-digit', timeZone:'Asia/Jakarta' }).formatToParts(d).reduce((a,p)=>{ a[p.type]=p.value; return a; },{});
      const pad = s => String(s).padStart(2,'0');
      return `${parts.year}-${pad(parts.month)}-${pad(parts.day)}`;
    }catch{ return ''; }
  }

  function todayWIBKey(){
    try{
      const d = new Date();
      const parts = new Intl.DateTimeFormat('id-ID', { year:'numeric', month:'2-digit', day:'2-digit', timeZone:'Asia/Jakarta' }).formatToParts(d).reduce((a,p)=>{ a[p.type]=p.value; return a; },{});
      const pad = s => String(s).padStart(2,'0');
      return `${parts.year}-${pad(parts.month)}-${pad(parts.day)}`;
    }catch{ return ''; }
  }

  // Persisted filters for Mix (via Settings)
  function getMixFilters(){
    try{
      const q = localStorage.getItem('mix_q') || '';
      const only = localStorage.getItem('mix_only_done');
      const onlyDone = (only == null) ? true : (only === '1');
      const sort = localStorage.getItem('mix_sort') || 'desc';
      const start = localStorage.getItem('mix_start') || '';
      const end = localStorage.getItem('mix_end') || '';
      try { const qEl = document.getElementById('mixQ'); if (qEl) { const v = (qEl.value||''); if (typeof v === 'string') q = v; } } catch {}
      return { q, onlyDone, sort, start, end };
    }catch{ return { q:'', onlyDone:true, sort:'desc', start:'', end:'' }; }
  }

  function mixFiltered(){
    const f = getMixFilters();
    const q = (f.q||'').toLowerCase();
    const onlyDone = !!f.onlyDone;
    const startKey = f.start || '';
    const endKey = f.end || '';
    return state.mix.data.filter(r=>{
      const hit = (r.tiket||'').toLowerCase().includes(q)
        || (r.nama||'').toLowerCase().includes(q)
        || (r.teknisi||'').toLowerCase().includes(q)
        || (r.tim||'').toLowerCase().includes(q)
        || (r.jenis||'').toLowerCase().includes(q)
        || (r.lokasi||'').toLowerCase().includes(q);
      const dk = toDateKeyWIB(r.waktu);
      const inStart = !startKey || (dk && dk >= startKey);
      const inEnd = !endKey || (dk && dk <= endKey);
      const dateOK = (!startKey && !endKey) ? true : (dk && inStart && inEnd);
      const done = (r.status||'').toLowerCase()==='selesai' || (r.teknisi||r.tim||r.foto);
      return hit && dateOK && (!onlyDone || done);
    });
  }

    function renderMix(){
    if(!state.mix.data.length) buildMix();
    // Filter + sort by waktu sesuai pilihan (default terbaru dulu)
    let rows = mixFiltered();
    const sortSel = (getMixFilters().sort || 'desc');
    const cmp = (a,b)=> (parseDate(a.waktu)||0) - (parseDate(b.waktu)||0);
    rows = rows.slice();
    if (sortSel === 'asc') rows.sort(cmp); else rows.sort((a,b)=> -cmp(a,b));
    const start = state.mix.idx * CFG.PAGE_SIZE;
    const items = rows.slice(start, start + CFG.PAGE_SIZE);
    const badge = s => `<span class="badge badge-status ${s}">${s||''}</span>`;
    document.getElementById('mixTb').innerHTML = items.map((r,i)=>{
      const pc = parsePhotos((r.fotoTeknisi||'') + ',' + (r.fotoAduan||'')).length;
      const fotoBtn = pc ? `<button class="btn btn-sm btn-outline-info mix-open-photo" data-idx="${start+i}"><i class="fas fa-image"></i> Foto <span class="badge text-bg-info">${pc}</span></button>` : '<span class="text-secondary">-</span>';
      const canSet = !!r.tiket;
      const actBtn = canSet ? `<div class="btn-group btn-group-sm">`
        + `<button class="btn btn-outline-light mix-set-status" data-idx="${start+i}" data-status="Proses">Proses</button>`
        + `<button class="btn btn-outline-light mix-set-status" data-idx="${start+i}" data-status="Selesai">Selesai</button>`
        + `</div>` : '';
      return `
      <tr>
        <td>${start+i+1}</td>
        <td class="text-nowrap">${fmtWIB(r.waktu)||''}</td>
        <td class="text-nowrap"><strong>${r.tiket||''}</strong></td>
        <td>${r.nama||''}${r.nopel?`<br><small class="text-secondary">${r.nopel}</small>`:''}${r.ketAduan?`<br><small class="text-secondary trunc-2" title="${escHtml(r.ketAduan)}">${escHtml(r.ketAduan)}</small>`:''}</td>
        <td>${r.teknisi||''}${r.tim?`<br><small class="text-secondary">${r.tim}</small>`:''}${r.catatan?`<br><small class="text-secondary trunc-2" title="${escHtml(r.catatan)}">${escHtml(r.catatan)}</small>`:''}</td>
        <td>${r.jenis||''}</td>
        <td>${badge(r.status||'')}</td>
        <td>${r.lokasi?`<a href="https://www.google.com/maps?q=${encodeURIComponent(r.lokasi)}" target="_blank"><i class="fas fa-location-dot"></i></a>`:''}</td>
        <td>${fotoBtn}</td>
        <td>${actBtn}</td>
      </tr>`;
    }).join('');
    document.getElementById('mixCount').textContent = `Menampilkan ${rows.length?start+1:0}-${Math.min(start+CFG.PAGE_SIZE, rows.length)} dari ${rows.length} data`;
    document.querySelectorAll('.mix-open-photo').forEach(btn=>{
      btn.addEventListener('click', ()=>{ const idx = Number(btn.getAttribute('data-idx'))||0; const r = rows[idx]; openMixDetail(r); });
    });
    document.querySelectorAll('.mix-set-status').forEach(btn=>{
      btn.addEventListener('click', async ()=>{ const idx = Number(btn.getAttribute('data-idx'))||0; const r = rows[idx]; const st = btn.getAttribute('data-status'); if(!r.tiket) return; await handleSetStatus(r.tiket, st); try{ buildMix(); renderMix(); }catch{} });
    });
  };

  function openDetail(item, focusPhotos=false){

    const photos = parsePhotos(item.foto);

    const fotoContent = photos.length
      ? `<div id="detailPhotos" class="photo-grid">${photos.map(u=>`<a href="${u}" target="_blank" rel="noopener"><img src="${u}" alt="Foto Teknisi"/></a>`).join('')}</div>`
      : '<em class="text-secondary">Tidak ada foto</em>';

    const fotoHtml = `<div class="mb-2"><div class="small text-secondary">Foto Teknisi</div>${fotoContent}</div>`;

    const mapHtml = item.lokasi && item.lokasi.includes(',') ? `<a href="https://www.google.com/maps?q=${encodeURIComponent(item.lokasi)}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-map-location-dot me-1"></i> Buka Maps</a>` : '<span class="text-secondary">Lokasi tidak tersedia</span>';

    document.getElementById('detailBody').innerHTML = `

      <div class="row g-3">

        <div class="col-md-6">

          <div class="mb-2"><strong>Tiket:</strong> ${escHtml(item.tiket)||'-'}</div>

          <div class="mb-2"><strong>Teknisi:</strong> ${escHtml(item.teknisi)||'-'}</div>

          <div class="mb-2"><strong>Tim/Rayon:</strong> ${escHtml(item.tim)||'-'}</div>

          <div class="mb-2"><strong>Waktu Selesai:</strong> ${escHtml(item.waktu)||'-'}</div>

          <div class="mb-2"><strong>Timestamp:</strong> ${escHtml(item.ts)||'-'}</div>

          <div class="mb-2"><strong>Lokasi:</strong> ${escHtml(item.lokasi)||'-'} ${mapHtml}</div>

          <div class="mb-2"><strong>Catatan:</strong><br>${escHtml(item.catatan).replace(/\n/g,'<br>')}</div>

        </div>

        <div class="col-md-6">${fotoHtml}</div>

      </div>`;

    const modalEl = document.getElementById('detailModal');

    const modal = new bootstrap.Modal(modalEl); modal.show();

    // image fallback: if blocked or not public, show open-link button instead

    setTimeout(()=>{

      document.querySelectorAll('#detailBody .photo-grid img').forEach(img=>{

        img.addEventListener('error', ()=>{

          const u = img.getAttribute('src') || '#';

          const a = document.createElement('a');

          a.href = u; a.target = '_blank'; a.rel = 'noopener';

          a.className = 'btn btn-sm btn-outline-light w-100';

          a.textContent = 'Buka Link Foto';

          img.replaceWith(a);

        }, { once:true });

      });

    }, 0);

    if(focusPhotos){

      setTimeout(()=>{

        const ph = document.getElementById('detailPhotos');

        if(ph) ph.scrollIntoView({behavior:'smooth', block:'start'});

      }, 150);

    }

  }



  function exportTekCSV(){

    const rows = tekFiltered();

    const header = ['Timestamp','Tiket','Teknisi','Tim/Rayon','Catatan','Lokasi (lat,lng)','Waktu Selesai','Foto Hasil'];

    const content = rows.map(r => [r.ts, r.tiket, r.teknisi, r.tim, r.catatan, r.lokasi, r.waktu, r.foto]);

    const csv = [header, ...content].map(e => e.map(escCsv).join(',')).join('\n');

    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});

    const url = URL.createObjectURL(blob);

    const a = document.createElement('a'); a.href = url; a.download = 'data-teknisi.csv'; a.click(); URL.revokeObjectURL(url);

  }



  // USERS table

  function renderUsers(){

    const q = (document.getElementById('userQ').value||'').toLowerCase();

    const rows = state.users.data.filter(x=> (x.nama||'').toLowerCase().includes(q) || (x.email||'').toLowerCase().includes(q));

    if(rows.length === 0){

      document.getElementById('userTb').innerHTML = `<tr><td colspan="5" class="text-center text-secondary">Tidak ada data pengguna. Pastikan Apps Script menyediakan mode "teknisi_users" atau fallback lain, dan di-deploy Web App (Anyone).</td></tr>`;

      document.getElementById('userCount').textContent = '0 pengguna';

      return;

    }

    document.getElementById('userTb').innerHTML = rows.map((u,i)=>`

      <tr>

        <td>${i+1}</td>

        <td>${u.nama||''}</td>

        <td>${u.email||''}</td>

        <td class="text-capitalize">${u.status||''}</td>

        <td>

          <div class="btn-group btn-group-sm">

            <button class="btn btn-outline-light" onclick="actUser('approve','${u.email}')">Approve</button>

            <button class="btn btn-outline-light" onclick="actUser('disable','${u.email}')">Disable</button>

            <button class="btn btn-outline-light" onclick="actUser('delete','${u.email}')">Delete</button>

          </div>

        </td>

      </tr>`).join('');

    document.getElementById('userCount').textContent = `${rows.length} pengguna`;

  }



  async function actUser(action, email){

    if(!confirm(`${action.toUpperCase()} ${email}?`)) return;

    const ok = (r)=> r && (r.status === 'ok' || r.status === 'success');

    try{

      // Primary: unified setter

      let json = await postAction({ mode:'teknisi_user_set', email, action });

      if(ok(json)) { await loadUsers(); alert('Berhasil: ' + action); return; }



      // Fallback 1: POST legacy specific modes

      const map = { approve:'teknisi_approve', disable:'teknisi_disable', delete:'teknisi_delete' };

      const legacy = map[action];

      if(legacy){

        json = await postAction({ mode: legacy, email });

        if(ok(json)) { await loadUsers(); alert('Berhasil (legacy): ' + action); return; }

      }



      // Fallback 2: GET legacy specific modes

      if(legacy){

        try{

          const resp = await fetch(`${CFG.GAS_URL}?mode=${encodeURIComponent(legacy)}&email=${encodeURIComponent(email)}`);

          const maybe = await resp.json().catch(()=>({}));

          if(resp.ok && ok(maybe)) { await loadUsers(); alert('Berhasil (legacy GET): ' + action); return; }

        }catch{ /* ignore */ }

      }



      alert('Gagal: ' + (json?.message || 'Unknown'));

    }catch(e){

      console.error('actUser error', e);

      alert('Gagal melakukan aksi: ' + e.message);

    }

  }



  // ===================== LOADERS =====================

  async function loadAduan(){

    setTableLoading('aduanTb', 8); document.getElementById('aduanCount').textContent = 'Memuat...';

    try{ state.aduan.data = await fetchAduan(); state.aduan.idx = 0; renderAduan(); }

    catch(e){ notify('danger','Gagal memuat aduan: ' + e.message); throw e; }

    finally{ renderOverview(); try{ buildMix(); renderMix(); }catch{} }

  }

  async function loadTek(){

    setTableLoading('tekTb', 7); document.getElementById('tekCount').textContent = 'Memuat...';

    try{ state.tek.data   = await fetchTeknisi(); state.tek.idx   = 0; renderTek(); }

    catch(e){ notify('danger','Gagal memuat data teknisi: ' + e.message); throw e; }

    finally{ renderOverview(); try{ buildMix(); renderMix(); }catch{} }

  }

  async function loadUsers(){

    setTableLoading('userTb', 5); document.getElementById('userCount').textContent = 'Memuat...';

    try{ state.users.data = await fetchUsers(); renderUsers(); }

    catch(e){ notify('danger','Gagal memuat pengguna: ' + e.message); throw e; }

  }



  // ===================== EVENTS =====================

  // Tombol Refresh All (single handler + spinner)

  document.getElementById('btnRefreshAll').addEventListener('click', async ()=>{

    const btn = document.getElementById('btnRefreshAll');

    try{

      btn.disabled = true;

      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Memuat...';

      await Promise.all([loadAduan(), loadTek(), loadUsers()]);

      notify('success','Data diperbarui');

    }catch(e){

      console.error(e);

      notify('danger','Gagal memuat data: ' + e.message);

    }finally{

      btn.disabled = false;

      btn.innerHTML = '<i class="fas fa-rotate me-1"></i>Refresh';

    }

  });



  // Aduan

  document.getElementById('btnAduanApply').addEventListener('click', renderAduan);

  document.getElementById('btnAduanReset').addEventListener('click', ()=>{ aduanQ.value=''; aduanStatus.value=''; renderAduan(); });

  document.getElementById('btnAduanReload').addEventListener('click', async ()=>{

    try{ await loadAduan(); }catch(e){ notify('danger','Gagal memuat aduan: ' + e.message); }

  });

  document.getElementById('aduanPrev').addEventListener('click', ()=>{ if(state.aduan.idx>0){ state.aduan.idx--; renderAduan(); } });

  document.getElementById('aduanNext').addEventListener('click', ()=>{ const total=aduanFiltered().length; if((state.aduan.idx+1)*CFG.PAGE_SIZE<total){ state.aduan.idx++; renderAduan(); } });

  document.getElementById('aduanQ').addEventListener('keydown', e=>{ if(e.key==='Enter') renderAduan(); });



  // Teknisi

  document.getElementById('btnTekApply').addEventListener('click', renderTek);

  document.getElementById('btnTekExport').addEventListener('click', exportTekCSV);

  document.getElementById('btnTekReload').addEventListener('click', async ()=>{

    try{ await loadTek(); }catch(e){ notify('danger','Gagal memuat data teknisi: ' + e.message); }

  });

  document.getElementById('tekPrev').addEventListener('click', ()=>{ if(state.tek.idx>0){ state.tek.idx--; renderTek(); } });

  document.getElementById('tekNext').addEventListener('click', ()=>{ const total=tekFiltered().length; if((state.tek.idx+1)*CFG.PAGE_SIZE<total){ state.tek.idx++; renderTek(); } });

  document.getElementById('tekQ').addEventListener('keydown', e=>{ if(e.key==='Enter') renderTek(); });

  document.getElementById('tekQtime').addEventListener('keydown', e=>{ if(e.key==='Enter') renderTek(); });



  // Mix
  document.getElementById('btnMixReload').addEventListener('click', ()=>{ try{ buildMix(); state.mix.idx=0; renderMix(); }catch(e){ notify('danger','Gagal gabungkan data: '+e.message); } });
  document.getElementById('mixPrev').addEventListener('click', ()=>{ if(state.mix.idx>0){ state.mix.idx--; renderMix(); } });
  document.getElementById('mixNext').addEventListener('click', ()=>{ const total=mixFiltered().length; if((state.mix.idx+1)*CFG.PAGE_SIZE<total){ state.mix.idx++; renderMix(); } });
  document.getElementById('mixQ').addEventListener('keydown', e=>{ if(e.key==='Enter') renderMix(); });
  document.getElementById('mixOnlyDone').addEventListener('change', renderMix);
  const _mixSortEl = document.getElementById('mixSort'); if(_mixSortEl){ _mixSortEl.addEventListener('change', ()=>{ state.mix.idx=0; renderMix(); }); }
  const _mixDateEl = document.getElementById('mixDate'); if(_mixDateEl){ _mixDateEl.addEventListener('change', ()=>{ state.mix.idx=0; renderMix(); }); }

  // Users

  document.getElementById('btnUserApply').addEventListener('click', renderUsers);

  document.getElementById('btnUserReload').addEventListener('click', async ()=>{

    try{ await loadUsers(); }catch(e){ notify('danger','Gagal memuat pengguna: ' + e.message); }

  });



  // Settings modal (inline)

  document.getElementById('btnSettings').addEventListener('click', ()=>{

    const curGas = CFG.GAS_URL; const curPage = CFG.PAGE_SIZE;
    const curMixQ    = localStorage.getItem('mix_q') || '';
    const curMixOnly = (localStorage.getItem('mix_only_done') ?? '1') === '1';
    const curMixSort = localStorage.getItem('mix_sort') || 'desc';
    const curMixStart= localStorage.getItem('mix_start') || '';
    const curMixEnd  = localStorage.getItem('mix_end') || '';

    const html = `

    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">

      <div class="modal-dialog">

        <div class="modal-content" style="background: rgba(16, 40, 78, 0.95); color:#fff;">

          <div class="modal-header">

            <h5 class="modal-title"><i class="fas fa-gear me-2"></i>Settings</h5>

            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Tutup"></button>

          </div>

          <div class="modal-body">

            <div class="mb-3">

              <label class="form-label">GAS URL</label>

              <input id="cfgGas" class="form-control" value="${curGas}">

              <small class="text-secondary">URL Web App Google Apps Script (Deploy: Execute as Me, Anyone).</small>

            </div>

            <div class="mb-3">

              <label class="form-label">Page Size</label>

              <input id="cfgPage" type="number" class="form-control" value="${curPage}" min="5" max="100">

            </div>

            <hr class="border-secondary opacity-25"/>

            <div class="mb-2 fw-bold"><i class="fas fa-layer-group me-2"></i>Filter Gabungan</div>

            <div class="row g-2 mb-2">
              <div class="col-sm-6">
                <label class="form-label">Kata kunci</label>
                <input id="cfgMixQ" class="form-control" placeholder="Cari tiket/nama/teknisi/alamat/jenis" value="${curMixQ}">
              </div>
              <div class="col-sm-6">
                <label class="form-label">Urutan</label>
                <select id="cfgMixSort" class="form-select">
                  <option value="desc" ${curMixSort==='desc'?'selected':''}>Terbaru dulu</option>
                  <option value="asc" ${curMixSort==='asc'?'selected':''}>Terlama dulu</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mb-2">
              <div class="col-sm-6">
                <label class="form-label">Tanggal mulai</label>
                <input id="cfgMixStart" type="date" class="form-control" value="${curMixStart}">
              </div>
              <div class="col-sm-6">
                <label class="form-label">Tanggal selesai</label>
                <input id="cfgMixEnd" type="date" class="form-control" value="${curMixEnd}">
              </div>
            </div>

            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="cfgMixOnly" ${curMixOnly?'checked':''}>
              <label class="form-check-label" for="cfgMixOnly">Hanya yang selesai (atau punya laporan teknisi)</label>
            </div>

          </div>

          <div class="modal-footer">

            <button class="btn btn-outline-light" data-bs-dismiss="modal">Tutup</button>

            <button class="btn btn-brand" id="btnSaveCfg">Simpan</button>

          </div>

        </div>

      </div>

    </div>`;

    const wrap = document.createElement('div'); wrap.innerHTML = html; document.body.appendChild(wrap);

    const modalEl = wrap.querySelector('#settingsModal');

    const modal = new bootstrap.Modal(modalEl); modal.show();

    modalEl.addEventListener('hidden.bs.modal', ()=> wrap.remove());

    wrap.querySelector('#btnSaveCfg').addEventListener('click', ()=>{

      const newGas = wrap.querySelector('#cfgGas').value.trim();

      const newPage = Number(wrap.querySelector('#cfgPage').value)||10;

      localStorage.setItem('cfg_gas', newGas);

      localStorage.setItem('cfg_page', newPage);

      // Save Mix filters
      try{
        localStorage.setItem('mix_q', (wrap.querySelector('#cfgMixQ').value||''));
        localStorage.setItem('mix_sort', (wrap.querySelector('#cfgMixSort').value||'desc'));
        localStorage.setItem('mix_start', (wrap.querySelector('#cfgMixStart').value||''));
        localStorage.setItem('mix_end', (wrap.querySelector('#cfgMixEnd').value||''));
        localStorage.setItem('mix_only_done', (wrap.querySelector('#cfgMixOnly').checked ? '1':'0'));
      }catch{}

      try{ buildMix(); state.mix.idx=0; renderMix(); }catch{}

      alert('Disimpan. Filter diterapkan. (GAS/PageSize perlu reload untuk terapkan sepenuhnya)');

    });

  });



  // ===================== INIT =====================

  (async function init(){

    try{

      // Fix pagination labels immediately
      try{ fixNavButtons(); }catch{}

      // Set default date (WIB) for Mix filter to today if empty
      try{ const dEl = document.getElementById('mixDate'); if(dEl && !dEl.value){ dEl.value = todayWIBKey(); } }catch{}

      await Promise.all([loadAduan(), loadTek(), loadUsers()]);

    }catch(e){

      console.error(e);

      notify('danger','Gagal memuat data awal. Cek GAS_URL & izin Web App (Anyone).');

    }

  })();

  // ===================== INPUT PENGADUAN (ADMIN) =====================
  (function(){
    const openBtn = document.getElementById('btnOpenInput'); if(!openBtn) return;
    const modalEl = document.getElementById('inputModal'); const modal = new bootstrap.Modal(modalEl);
    const submitBtn = document.getElementById('admBtnSubmitInput');
    const aMsg = (type, msg)=>{ const box=document.getElementById('admInputAlert'); if(box) box.innerHTML = `<div class="alert alert-${type}">${msg}</div>`; };
    const toDataURL = (file)=> new Promise((res,rej)=>{ if(!file) return res(""); const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
    const latEl = document.getElementById('admInLat'); const lngEl = document.getElementById('admInLng');
    const statLat = document.getElementById('admInLatStat'); const statLng = document.getElementById('admInLngStat'); const statAcc = document.getElementById('admInAccStat');
    const setLoc = (lat,lng,acc)=>{ if(latEl) latEl.value = (lat!=null?Number(lat).toFixed(6):''); if(lngEl) lngEl.value=(lng!=null?Number(lng).toFixed(6):''); if(statLat) statLat.textContent=latEl.value||'-'; if(statLng) statLng.textContent=lngEl.value||'-'; if(statAcc) statAcc.textContent=(acc!=null?('Â± '+Math.round(acc)+' m'):'-'); };
    document.getElementById('admInBtnClear').addEventListener('click', ()=> setLoc(null,null,null));
    document.getElementById('admInBtnGeo').addEventListener('click', ()=>{
      if(!navigator.geolocation) return aMsg('warning','Geolocation tidak didukung browser.');
      navigator.geolocation.getCurrentPosition(pos=> setLoc(pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy), err=> aMsg('danger','Gagal ambil lokasi. Izin lokasi diperlukan.'), {enableHighAccuracy:true,timeout:8000,maximumAge:0});
    });
    // Map picker
    const mapModalEl = document.getElementById('admMapPickModal'); let map=null,marker=null; let mapModal;
    function initMap(){ if(map||typeof L==='undefined') return; map=L.map('admMapPick',{zoomControl:true,preferCanvas:true}).setView([-6.9147,107.6098],12); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map); map.on('click',e=>{ const p=e.latlng; if(!marker) marker=L.marker([p.lat,p.lng]).addTo(map); else marker.setLatLng(p); }); setTimeout(()=>{ try{ map.invalidateSize(); }catch{} },0); }
    document.getElementById('admInBtnUseMap').addEventListener('click', ()=>{ mapModal=new bootstrap.Modal(mapModalEl); mapModal.show(); setTimeout(()=>initMap(),100); });
    document.getElementById('admBtnMapUseGPS').addEventListener('click', ()=>{ if(!navigator.geolocation) return aMsg('warning','Geolocation tidak didukung'); navigator.geolocation.getCurrentPosition(pos=>{ initMap(); const la=pos.coords.latitude, lo=pos.coords.longitude; if(!marker) marker=L.marker([la,lo]).addTo(map); else marker.setLatLng([la,lo]); map.setView([la,lo], Math.max(map.getZoom(),16)); }, ()=> aMsg('danger','Gagal ambil lokasi GPS'), {enableHighAccuracy:true,timeout:8000,maximumAge:0}); });
    document.getElementById('admBtnMapSave').addEventListener('click', ()=>{ if(!marker) { aMsg('warning','Klik peta untuk pilih lokasi.'); return; } const p=marker.getLatLng(); setLoc(p.lat,p.lng,null); try{ mapModal.hide(); }catch{} });

    openBtn.addEventListener('click', ()=>{ aMsg('', ''); modal.show(); });
    const clearForm = ()=>{ ['admInNama','admInNopel','admInAlamat','admInKontak','admInKet','admInLat','admInLng'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; }); const je=document.getElementById('admInJenis'); if(je) je.selectedIndex=0; const fe=document.getElementById('admInFoto'); if(fe) fe.value=''; setLoc(null,null,null); try{ document.getElementById('admInNama').focus(); }catch{} };
    submitBtn.addEventListener('click', async ()=>{
      try{
        submitBtn.disabled=true; submitBtn.innerHTML='<i class="fas fa-spinner fa-spin me-1"></i>Kirim...';
        const nama=(document.getElementById('admInNama').value||'').trim();
        const nopel=(document.getElementById('admInNopel').value||'').trim();
        const alamat=(document.getElementById('admInAlamat').value||'').trim();
        const kontak=(document.getElementById('admInKontak').value||'').trim();
        const jenis=(document.getElementById('admInJenis').value||'');
        const ket=(document.getElementById('admInKet').value||'').trim();
        const lat=(document.getElementById('admInLat').value||'').trim();
        const lng=(document.getElementById('admInLng').value||'').trim();
        if(!nama || !alamat){ aMsg('warning','Nama dan alamat wajib diisi.'); return; }
        const lokasi = (lat && lng) ? (lat+','+lng) : '';
        const fotoFile=document.getElementById('admInFoto').files[0];
        const dokumentasi = await toDataURL(fotoFile);
        const payload = new URLSearchParams({ nama:nama, nopelanggan:nopel, alamat:alamat, kontak:kontak, jenis:jenis, keterangan:ket, lokasi:lokasi, dokumentasi:dokumentasi });
        aMsg('info','Mengirim...');
        const resp = await fetch(CFG.GAS_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body: payload.toString() });
        let json={}; try{ json=await resp.json(); }catch{}
        if(json && (json.status==='success' || json.status==='ok')){ aMsg('success','Aduan terkirim! Tiket: <strong>'+ (json.ticket||'') +'</strong>'); clearForm(); try{ await loadAduan(); buildMix(); renderMix(); }catch{} }
        else { aMsg('danger','Gagal kirim: '+((json&&json.message)||('HTTP '+resp.status))); }
      }catch(e){ console.error(e); aMsg('danger','Error: '+e.message); }
      finally{ submitBtn.disabled=false; submitBtn.innerHTML='Kirim'; }
    });
  })();

    function openMixDetail(r){
    const photosTek = parsePhotos(r.fotoTeknisi||'');
    const photosAdu = parsePhotos(r.fotoAduan||'');
    const mapBtn = (loc)=> loc && String(loc).includes(',')
      ? `<a href="https://www.google.com/maps?q=${encodeURIComponent(loc)}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-map-location-dot me-1"></i> Buka Maps</a>`
      : '<span class="text-secondary">Lokasi tidak tersedia</span>';

    const pengaduanTable = `
      <table class="table table-dark table-sm mb-3">
        <thead><tr><th colspan="2"><i class="fas fa-bullhorn me-2"></i>Detail Pengaduan</th></tr></thead>
        <tbody>
          <tr><td class="col-fit">Tiket</td><td><strong>${escHtml(r.tiket||'-')}</strong></td></tr>
          <tr><td>Pelanggan</td><td>${escHtml(r.nama||'-')}${r.nopel?` <small class="text-secondary">(${escHtml(r.nopel)})</small>`:''}</td></tr>
          <tr><td>Jenis</td><td>${escHtml(r.jenis||'-')}</td></tr>
          <tr><td>Status</td><td>${escHtml(r.status||'-')}</td></tr>
          <tr><td>Waktu</td><td>${fmtWIB(r.waktu)||'-'}</td></tr>
          <tr><td>Lokasi</td><td>${escHtml(r.lokasi||'-')} ${mapBtn(r.lokasi||'')}</td></tr>
          ${r.ketAduan?`<tr><td>Keterangan</td><td>${escHtml(r.ketAduan).replace(/\n/g,'<br>')}</td></tr>`:''}
        </tbody>
      </table>`;

    const teknisiTable = `
      <table class="table table-dark table-sm mb-3">
        <thead><tr><th colspan="2"><i class="fas fa-screwdriver-wrench me-2"></i>Detail Teknisi</th></tr></thead>
        <tbody>
          <tr><td class="col-fit">Teknisi</td><td>${escHtml(r.teknisi||'-')}</td></tr>
          <tr><td>Tim/Rayon</td><td>${escHtml(r.tim||'-')}</td></tr>
          <tr><td>Waktu</td><td>${fmtWIB(r.waktu)||'-'}</td></tr>
          <tr><td>Lokasi</td><td>${escHtml(r.lokasi||'-')} ${mapBtn(r.lokasi||'')}</td></tr>
          ${r.catatan?`<tr><td>Catatan</td><td>${escHtml(r.catatan).replace(/\n/g,'<br>')}</td></tr>`:''}
        </tbody>
      </table>`;

    const photosBlock = `
      <div class="row g-3">
        <div class="col-md-6">${photosAdu.length?`<div class="small text-secondary mb-1">Foto Pengaduan</div>`:''}
          <div class="photo-grid">${photosAdu.map(u=>`<a href="${u}" target="_blank" rel="noopener"><img src="${u}" alt="Foto Pengaduan"/></a>`).join('') || '<em class="text-secondary">Tidak ada foto</em>'}</div>
        </div>
        <div class="col-md-6">${photosTek.length?`<div class="small text-secondary mb-1">Foto Teknisi</div>`:''}
          <div class="photo-grid">${photosTek.map(u=>`<a href="${u}" target="_blank" rel="noopener"><img src="${u}" alt="Foto Teknisi"/></a>`).join('') || '<em class="text-secondary">Tidak ada foto</em>'}</div>
        </div>
      </div>`;

    document.getElementById('detailBody').innerHTML = pengaduanTable + teknisiTable + photosBlock;
    const modalEl = document.getElementById('detailModal');
    new bootstrap.Modal(modalEl).show();
    setTimeout(()=>{
      document.querySelectorAll('#detailBody .photo-grid img').forEach(img=>{
        img.addEventListener('error', ()=>{
          const u = img.getAttribute('src') || '#';
          const a = document.createElement('a'); a.href=u; a.target='_blank'; a.rel='noopener'; a.className='btn btn-sm btn-outline-light w-100'; a.textContent='Buka Link Foto'; img.replaceWith(a);
        }, { once:true });
      });
    },0);
  }
</script>

  <!-- Mobile Bottom Nav (visible only on small screens) -->
  <nav class="mobile-nav d-sm-none">
    <a href="index.html" class="active" aria-label="Home"><i class="fas fa-house"></i></a>
    <a href="peta.html" aria-label="Peta"><i class="fas fa-map"></i></a>
    <a href="Layanan.html" aria-label="Pengaduan"><i class="fas fa-bullhorn"></i></a>
    <a href="tekanan.html" aria-label="Logger"><i class="fas fa-gauge-high"></i></a>
  </nav>

</body>

</html>












